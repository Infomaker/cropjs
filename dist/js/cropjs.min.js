/**
 * cropjs - Image soft cropper for predefined crop definitions featuring automatic crop suggestions. Created by Infomaker Scandinavia AB
 * @author Danne Lundqvist <danne.lundqvist@infomaker.se>
 * @version v1.1.0
 * @link http://www.infomaker.se
 * @license MIT
 */
!function(){this.IMCropUI=function(){},IMCropUI.Toggle=function(t,i){var e,a=t,s=!1,n=i,o=this;if(e=document.getElementById(a),!e)return void console.log("Element not found: "+a);e.classList.contains("on")&&(s=!0);var r=e.getElementsByTagName("em");1==r.length&&r[0].classList.contains("hint")&&(e.title=r[0].innerHTML),Object.defineProperty(this,"on",{get:function(){return s},set:function(t){s=t,t&&!e.classList.contains("on")?e.classList.add("on"):!t&&e.classList.contains("on")&&e.classList.remove("on")}}),e.addEventListener("click",function(t){return this.classList.toggle("on"),t.preventDefault(),t.stopPropagation(),s=this.classList.contains("on"),"function"==typeof n&&n.call(o,t),!1})},IMCropUI.Button=function(t,i){var e,a=t,s=i,n=this;return(e=document.getElementById(a))?void e.addEventListener("click",function(t){return t.preventDefault(),t.stopPropagation(),"function"==typeof s&&s.call(n,t),!1}):void console.log("Element not found: "+a)}}();var IMSoftcrop=function(){var t={};return t.Editor=function(i,e){if(this._id=i,this._crops=[],"object"==typeof e&&e.debug===!0&&(this._debug=!0),this.setupUI(),this.adjustForPixelRatio(),this.calculateViewport(),this.addCanvasEventListeners(),this.setupAnimation(),this.runAnimation(),"object"==typeof e){var a=this;e.debug===!0&&this._debug&&(this._debugContainer=e.debugElement),e.autocrop===!0&&(this._autocrop=!0),"string"==typeof e.detectWorkerUrl&&(this._detectWorkerUrl=e.detectWorkerUrl),"number"==typeof e.detectThreshold&&(this._detectThreshold=e.detectThreshold),"number"==typeof e.detectStepSize&&(this._detectStepSize=e.detectStepSize)}this._cropLockedToggle=new IMCropUI.Toggle("imc_croplocked",function(){a._crop instanceof t.Softcrop&&(a._crop.locked=this.on,a._renderUpdatedPreview(a._crop))}),this._cropUsableToggle=new IMCropUI.Toggle("imc_cropusable",function(){a._crop instanceof t.Softcrop&&(a._crop.usable=this.on,a._renderUpdatedPreview(a._crop))}),this._guidesToggle=new IMCropUI.Toggle("imc_guides",function(){a.redraw()}),this._focusPointsToggle=new IMCropUI.Toggle("imc_focuspoints",function(){a.redraw()})},t.Editor.prototype={_id:"",_container:void 0,_canvas:void 0,_ctx:void 0,_redrawCanvas:!1,_previewContainer:void 0,_debugContainer:void 0,_image:void 0,_crops:void 0,_crop:void 0,handle:void 0,info:"image",_dragObject:void 0,_dragPoint:void 0,_position:{x:0,y:0},_zoomLevel:1,_keepCenter:!1,_scale:1,_margin:5,_waitForWorkers:0,_zoomMax:5,_zoomMin:.1,_autocrop:!1,_applyAutocrop:!0,_detectWorkerUrl:void 0,_detectThreshold:60,_detectStepSize:1.6,_debug:!1,_onSave:void 0,_onCancel:void 0,_guidesToggle:void 0,_focusPointsToggle:void 0,_cropLockedToggle:void 0,_cropUsableToggle:void 0,setupUI:function(){if(this.injectHTML(),this._container=document.getElementById("imc_container"),!this._container)throw new Error("Container element with id <imc_container> not found");if(this._previewContainer=document.getElementById("imc_preview_container"),!this._previewContainer)throw new Error("Preview element with id <imc_preview_container> not found");if(this._canvas=document.getElementById("imc_canvas"),!this._canvas)throw new Error("Canvas element with id <imc_canvas_initial> not found");this._ctx=this._canvas.getContext("2d")},injectHTML:function(){var t=document.getElementById(this._id);if(!t)throw new Error("Could not find element with id <"+this._id+"> to inject crop editor into");var i=this._debug?"imc_debug":"";t.innerHTML='<div id="imc" class="'+i+'"><div id="imc_container"><canvas id="imc_canvas"></canvas><div id="imc_work_container"><div id="imc_preview_container" class="imc_preview_container"></div></div><div id="imc_image_inline"><div class="imc_debug_group"><a href="#" id="imc_focuspoints" class="toggle"><em class="hint">Detaljer</em><span><span class="on"><i class="fa fa-object-group"></i></span><span class="off"><i class="fa fa-object-group"></i></span></span></a><a href="#" id="imc_guides" class="toggle on"><em class="hint">Guide lines</em><span><span class="on"><i class="fa fa-th"></i></span><span class="off"><i class="fa fa-th"></i></span></span></a><a href="#" id="imc_croplocked" class="toggle"><em class="hint">Låst till användare</em><span><span class="on"><i class="fa fa-lock"></i></span><span class="off"><i class="fa fa-unlock"></i></span></span></a><a href="#" id="imc_cropusable" class="toggle"><em class="hint">Använd denna crop</em><span><span class="on"><i class="fa fa-check"></i></span><span class="off"><i class="fa fa-ban"></i></span></span></a></div><div id="imc_image_info" class="display"></div><div id="imc_loading"><i class="fa fa-cog fa-spin"></i></div></div></div></div>'},setupAnimation:function(){for(var t=0,i=["webkit","moz"],e=0;e<i.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[i[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[i[e]+"CancelAnimationFrame"]||window[i[e]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(i,e){var a=(new Date).getTime(),s=Math.max(0,16-(a-t)),n=window.setTimeout(function(){i(a+s)},s);return t=a+s,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})},runAnimation:function(){var i=this;if(requestAnimationFrame(function(){i.runAnimation()}),this._redrawCanvas){if(this.calculateViewport(),this._redrawCanvas=!1,this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._image instanceof t.Image){this._image.redraw({guides:this._guidesToggle.on,focuspoints:this._focusPointsToggle.on});for(var e=this._image.getSoftCrops(),a=0;a<e.length;a++)e[a]instanceof t.Softcrop&&this._renderUpdatedPreview(e[a])}this._debug&&this._renderDebug()}},redraw:function(){this._redrawCanvas=!0},toggleLoadingImage:function(t){var i=document.getElementById("imc_loading");return"undefined"==typeof t?i.classList.contains("loading"):(t?i.classList.add("loading"):i.classList.remove("loading"),t)},_renderNewCropPreview:function(i,e){var a=this,s=document.createElement("div");s.id=this._image.id+"_"+i.id,s.classList.add("imc_preview_image_container"),e&&s.classList.add("active"),s.addEventListener("click",function(){a.setActiveCrop(i)});var n=document.createElement("div");n.classList.add("imc_preview_image");var o=90;t.Ratio.width(o,i.ratio.f);n.style.width=t.Ratio.width(o,i.ratio.f)+"px";var r=document.createElement("span"),h=document.createElement("em"),c=document.createElement("i");c.className="fa fa-warning";var d=document.createElement("b"),l=i;d.className="fa fa-check",d.addEventListener("click",function(t){return a.toggleCropUsable(l),t.preventDefault(),t.stopPropagation(),!1}),h.appendChild(document.createTextNode(i.id)),r.appendChild(d),r.appendChild(h),r.appendChild(c);var u=document.createElement("img");u.src=this._image.src,n.appendChild(u),n.appendChild(r),s.appendChild(n),this._previewContainer.appendChild(s),this._renderUpdatedPreview(i)},_renderUpdatedPreview:function(i){var e=document.getElementById(this._image.id+"_"+i.id);if(null!=e&&"object"==typeof e){var a=e.getElementsByTagName("DIV")[0],s=e.getElementsByTagName("IMG")[0],n=window.getComputedStyle(a).height.slice(0,-2),o=this._image.getDimensions(),r=t.Ratio.width(n,i.ratio.f);a.style.width=r+"px";var h=i.getDimensions(),c=r/h.w;s.style.height=o.h*c+"px",s.style.marginTop="-"+h.y*c+"px",s.style.marginLeft="-"+h.x*c+"px",1==i.autoCropWarning?e.classList.add("warning"):e.classList.remove("warning"),1==i.usable?(e.classList.add("usable"),e.classList.remove("unusable")):(e.classList.add("unusable"),e.classList.remove("usable"))}},getDimensions:function(){return{margin:this._margin,width:this._canvas.width,height:this._canvas.height}},updateImageInfo:function(i){var e,a,s,n=i?"crop":"image",o=document.getElementById("imc_image_info");if(o){if(i){if(this._crop instanceof t.Softcrop==0)return;e=this._crop.getDimensions()}else{if(this._image instanceof t.Image==0)return;e=this._image.getDimensions()}if(a=Math.round(e.w),s=Math.round(e.h),this.info==n)return void(o.innerHTML=a+"x"+s);this.info=n,o.className="",setTimeout(function(){o.innerHTML=a+"x"+s,o.className="display "+n},200)}},adjustForPixelRatio:function(t){var i=t||this._canvas,e=i.getContext("2d"),a=window.devicePixelRatio||1,s=e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1,n=a/s;if(a!==s){var o=this._container.clientWidth,r=this._container.clientHeight;i.width=o*n,i.height=r*n,i.style.width=o+"px",i.style.height=r+"px",e.scale(n,n),this._scale=n}else i.width=this._container.clientWidth,i.height=this._container.clientHeight},addImage:function(i,e,a){var s=this;this.toggleLoadingImage(!0),this.clear(),this._applyAutocrop=a!==!1,this._image=new t.Image(t.Ratio.hashFnv32a(i),this),this._image.load(i,function(){s.setZoomToImage(!1),s.centerImage(!1),s.updateImageInfo(!1),s._autocrop?(s.detectDetails(),s.detectFaces()):s.toggleLoadingImage(!1),s.applySoftcrops(),s.redraw(),"function"==typeof e&&e.call(s,s._image)})},addSoftcrop:function(i,e,a,s,n,o,r){var h=!1;a=parseFloat(a),s=parseFloat(s),"undefined"==typeof n||"undefined"==typeof o||null===n||null===o?(n=null,o=null):(n=parseInt(n),o=parseInt(o),h=!0),r="undefined"==typeof r||r,this._crops.push({id:i,setAsCurrent:0==this._crops.length||e,hRatio:a,vRatio:s,x:n,y:o,exact:h,usable:!!r}),this._image instanceof t.Image&&this._image.ready&&this.applySoftcrops()},getSoftcropData:function(){for(var t={src:this._image.src,width:this._image.w,height:this._image.h,crops:[]},i=0;i<this._image.crops.length;i++)t.crops.push({id:this._image.crops[i].id,x:Math.round(this._image.crops[i].x),y:Math.round(this._image.crops[i].y),width:Math.round(this._image.crops[i].w),height:Math.round(this._image.crops[i].h),usable:this._image.crops[i].usable});return t},applySoftcrops:function(){if(this._image instanceof t.Image!=0&&this._image.ready)for(var i=0;i<this._crops.length;i++){var e=this._image.getSoftcrop(this._crops[i].id);if(null==e){var e=this._image.addSoftcrop(this._crops[i].id,this._crops[i].setAsCurrent,this._crops[i].hRatio,this._crops[i].vRatio,this._crops[i].x,this._crops[i].y,this._crops[i].exact,this._crops[i].usable);this._autocrop&&this._image.autocrop(),this._renderNewCropPreview(e,this._crops[i].setAsCurrent)}this._crops[i].setAsCurrent&&this.setActiveCrop(e)}},setActiveCrop:function(i){if(i instanceof t.Softcrop==!0){for(var e=document.getElementById(this._image.id+"_"+i.id),a=this._previewContainer.getElementsByClassName("imc_preview_image_container"),s=0;s<a.length;s++)a[s].classList.remove("active");e.classList.add("active"),this._crop=i,this._image.setActiveCrop(i),this._cropLockedToggle.on=i.locked,this._cropUsableToggle.on=i.usable,this.redraw(),this.updateImageInfo(!0)}},toggleCropUsable:function(t){"undefined"==typeof t&&(t=this._crop),t.usable=!t.usable,this._renderUpdatedPreview(t),t.id===this._crop.id&&(this._cropUsableToggle.on=t.usable)},clear:function(){this._image instanceof t.Image!=0&&(this._image.clear(),this._crops=[],this._crop=void 0,this._image=void 0,this._previewContainer.innerHTML="",this.redraw())},autocropImages:function(){this._autocrop&&this._applyAutocrop&&(this.toggleLoadingImage()||this.toggleLoadingImage(!0),this._image.autocrop()&&this.redraw()),0==this._waitForWorkers&&this.toggleLoadingImage(!1)},getImageData:function(){if(!(!this._image instanceof t.Image)&&this._image.ready){var i=document.getElementsByTagName("body"),e=document.createElement("canvas"),a=e.getContext("2d");e.style.display="none",i[0].appendChild(e),e.width=this._image.w,e.height=this._image.h,e.style.width=this._image.w+"px",e.style.height=this._image.h+"px",a.drawImage(this._image.image,0,0,this._image.w,this._image.h);var s=a.getImageData(0,0,this._image.w,this._image.h);return a=null,i[0].removeChild(e),e=null,i[0]=null,i=null,s}},detectDetails:function(){if(!(!this._image instanceof t.Image)&&this._image.ready){var i=this,e=this.getImageData();if(this._waitForWorkers++,window.Worker){var a=new Worker(this._detectWorkerUrl);a.postMessage(["details",e,this._image.w,this._image.h,this._detectThreshold]),a.onmessage=function(t){i.addDetectedDetails(t.data),i._waitForWorkers--,i.autocropImages()}}else{var s=tracking.Fast.findCorners(tracking.Image.grayscale(e.data,this._image.w,this._image.h),this._image.w,this._image.h,this._detectThreshold);this.addDetectedDetails(s),this._waitForWorkers--,this.autocropImages()}}},addDetectedDetails:function(t){for(var i=[],e=0;e<t.length;e+=2)i.push({x:t[e],y:t[e+1]});this._image.addDetailData(i)},detectFaces:function(){if(!(!this._image instanceof t.Image)&&this._image.ready){this._waitForWorkers++;var i=this;if(window.Worker){var e=new Worker(this._detectWorkerUrl);e.postMessage(["features",this.getImageData(),this._image.w,this._image.h,this._detectStepSize]),e.onmessage=function(t){for(var e=0;e<t.data.length;e++)i.addDetectedFeature(t.data[e]);i._waitForWorkers--,i.autocropImages()}}else{tracking.trackData=function(t,i,e,a){var s=new tracking.TrackerTask(t);return s.on("run",function(){t.track(i.data,e,a)}),s.run()};var a=new tracking.ObjectTracker(["face"]);a.setStepSize(this._detectStepSize),a.on("track",function(t){t.data.forEach(function(t){i.addDetectedFeature(t)}),i._waitForWorkers--,i.autocropImages()}),tracking.trackData(a,this.getImageData(),this._image.w,this._image.h)}}},addDetectedFeature:function(t){var i=0,e={x:t.x,y:t.y};t.width/this._image.w>.45?(t.height*=1.2,e.x+=t.width/2,e.y+=t.height/2,i=t.height>t.width?t.height/2:t.width/2):(t.height*=1.4,e.x+=t.width/2,e.y+=t.height/4,i=t.height>t.width?t.height/2:t.width/2),this._image.addFocusPoint(e,i)},canvasLineInImage:function(t){return t/this._zoomLevel},imageLineInCanvas:function(t){return t*this._zoomLevel},imagePointInCanvas:function(t,i){return{x:Math.round((t+this._image.x)*this._zoomLevel)+this._margin,y:Math.round((i+this._image.y)*this._zoomLevel)+this._margin}},canvasPointInImage:function(t,i){return{x:Math.round((t-this._margin)/this._zoomLevel)-this._image.x,y:Math.round((i-this._margin)/this._zoomLevel)-this._image.y}},centerImage:function(t){var i,e;this._keepCenter=!0,i=this._container.clientWidth/2,e=this._container.clientHeight/2;var a=this._image.w*this._zoomLevel/2+this._image.x*this._zoomLevel+this._margin,s=this._image.h*this._zoomLevel/2+this._image.y*this._zoomLevel+this._margin,n=i==a?0:(i-a)/this._zoomLevel,o=e==s?0:(e-s)/this._zoomLevel;this._image.move({x:n,y:o}),t===!0&&this.redraw()},getZoom:function(t){return t===!0?this._zoomLevel:100*this._zoomLevel},setZoom:function(t,i){this._zoomLevel=t/100,this._keepCenter&&this.centerImage(!1),i===!0&&this.redraw()},setZoomToImage:function(t){var i=this._image.getDimensions(),e=(this._container.clientHeight-2*this._margin)/i.h,a=(this._container.clientWidth-2*this._margin)/i.w;if(e<a&&e<1&&this._zoomLevel>e)this._zoomLevel=e,this.centerImage(!1);else{if(!(a<1&&this._zoomLevel>a))return;this._zoomLevel=a,this.centerImage(!1)}t===!0&&this.redraw()},addCanvasEventListeners:function(){var t=this;window.addEventListener("resize",function(){t.onResize(event)},!1),this._canvas.addEventListener("dblclick",function(i){return t.onDoubleClick(i)}),this._canvas.addEventListener("mousedown",function(i){t.onMouseDown(i)}),this._canvas.addEventListener("mouseup",function(i){t.onMouseUp(i)}),window.addEventListener("mouseup",function(i){t.onMouseUp(i)}),this._canvas.addEventListener("mousemove",function(i){t.onMouseMove(i)}),this._canvas.addEventListener("mousewheel",function(i){return i.stopPropagation(),i.preventDefault(),t.onMouseWheel(i),!1},!1),document.addEventListener("keydown",function(i){var e=i.keyCode||i.which;if(13===e)return t._onSave(t.getSoftcropData()),i.preventDefault(),i.stopPropagation(),!1;if(27===e)return t._onCancel(),i.preventDefault(),i.stopPropagation(),!1;if(9===e){for(var a,s=t._image.getSoftCrops(),n=0;n<s.length;n++)if(t._crop===s[n]){a=n;break}return"undefined"!=typeof a&&(n+=i.shiftKey?-1:1,n<0?n=s.length-1:n+1>s.length&&(n=0),t.setActiveCrop(s[n])),i.preventDefault(),i.stopPropagation(),!1}},!1)},onSave:function(t){"function"==typeof t&&(this._onSave=t)},onCancel:function(t){"function"==typeof t&&(this._onCancel=t)},onResize:function(){this._keepCenter&&this.centerImage(!1),this.redraw()},onDoubleClick:function(t){if(t.preventDefault(),t.stopPropagation(),"undefined"==typeof this._image)return!1;this.toggleLoadingImage(!0);var i=this.getMousePoint(t);return this._image.addFocusPoint(this.canvasPointInImage(i.x,i.y),40),this._image.autocrop()&&(this.redraw(),this.toggleLoadingImage(!1)),!1},onMouseDown:function(i){var e=this.getMousePoint(i);this._crop instanceof t.Softcrop&&"string"==typeof this.handle?(this.updateImageInfo(!0),this._dragPoint=e,this._dragObject=this.handle):this._crop instanceof t.Softcrop&&this._crop.inArea(e)?(this.updateImageInfo(!0),this._dragObject=this._crop,this._dragPoint=e):this._image instanceof t.Image&&this._image.inArea(e)&&(this.updateImageInfo(!1),this._dragObject=this._image,this._dragPoint=e)},onMouseUp:function(){this._dragObject=void 0,this._dragPoint=void 0},onMouseMove:function(i){var e=this.getMousePoint(i);if("undefined"!=typeof this._dragObject)return"string"==typeof this._dragObject?(this._image.detectionReady()||(this._crop.locked=!0),this._crop.dragHandle(this._dragObject,{x:(e.x-this._dragPoint.x)/this._zoomLevel,y:(e.y-this._dragPoint.y)/this._zoomLevel}),this.updateImageInfo(!0)):(this._dragObject instanceof t.Image&&(this._keepCenter=!1),this._dragObject.move({x:(e.x-this._dragPoint.x)/this._zoomLevel,y:(e.y-this._dragPoint.y)/this._zoomLevel})),this.updateImageInfo(!0),this.redraw(),void(this._dragPoint=e);if(this._crop instanceof t.Softcrop){var a=this._crop.overHandle(e);if(a!==!1&&this.handle!=a)return"nw"==a||"se"==a?this._canvas.style.cursor="nwse-resize":"ne"==a||"sw"==a?this._canvas.style.cursor="nesw-resize":"n"==a||"s"==a?this._canvas.style.cursor="ns-resize":this._canvas.style.cursor="ew-resize",void(this.handle=a);if(a===!1&&this.handle)return this._canvas.style.cursor="default",void(this.handle=void 0);if(this.handle)return}return this._image instanceof t.Image&&this._image.inArea(e)?void(this._canvas.style.cursor="move"):void(this._canvas.style.cursor="default")},onMouseWheel:function(t){var i=Math.max(-1,Math.min(1,t.wheelDelta||-t.detail)),e=0;if(i<0&&this._zoomLevel<this._zoomMax)e=this._zoomLevel<1?.01:.03;else{if(!(i>0&&this._zoomLevel>this._zoomMin))return;e=this._zoomLevel<1?-.01:-.03}var a=(this._image.w/2+this._image.x)*e,s=(this._image.h/2+this._image.y)*e;this._zoomLevel+=e,this._image.move({x:-a/this._zoomLevel,y:-s/this._zoomLevel}),this.redraw()},getMousePoint:function(t){return{x:t.pageX-this._position.x,y:t.pageY-this._position.y}},getCanvas:function(){return this._canvas},calculateViewport:function(){var i=t.Ratio.getElementPosition(this._canvas);this._position.x=i.x,this._position.y=i.y},_renderDebug:function(){if(this._drawCross("red",{x:this._container.clientWidth/2,y:this._container.clientHeight/2}),this._drawCross("green",{x:this._image.w*this._zoomLevel/2+this._image.x*this._zoomLevel+this._margin,y:this._image.h*this._zoomLevel/2+this._image.y*this._zoomLevel+this._margin}),"undefined"!=typeof this._debugContainer){var t="<pre>";t+="Zoom level: "+this._zoomLevel+"\n","undefined"!=typeof this._image&&(t+="Image w: "+this._image.w+"\n",t+="      h: "+this._image.h+"\n",t+="\n","undefined"!=typeof this._image.crop&&(t+="Crop  x: "+this._image.crop.x+"\n",t+="      y: "+this._image.crop.y+"\n",t+="      w: "+this._image.crop.w+"\n",t+="      h: "+this._image.crop.h+"\n")),t+="</pre>",this._debugContainer.innerHTML=t}},_drawCross:function(t,i){var e=this._canvas.getContext("2d");e.beginPath(),e.fillStyle=t,e.strokeStyle=t,e.lineWidth=.5,e.arc(i.x,i.y,5,0,2*Math.PI,!1),e.fill(),e.beginPath(),e.moveTo(i.x-50,i.y),e.lineTo(i.x+50,i.y),e.stroke(),e.beginPath(),e.moveTo(i.x,i.y-50),e.lineTo(i.x,i.y+50),e.stroke()}},t}();!function(t){t.Ratio=function(){},t.Ratio.decimal=function(t,i){return i/t},t.Ratio.height=function(t,i){return Math.round(t*i)},t.Ratio.width=function(t,i){return Math.round(t/i)},t.Ratio.fitInto=function(i,e){var a=t.Ratio.decimal(e.w,e.h),s=t.Ratio.decimal(i.w,i.h),n=0,o=0,r=i.w,h=i.h;return a<s?(h=t.Ratio.height(r,a),o=(i.h-h)/2):(r=t.Ratio.width(h,a),n=(i.w-r)/2),{x:n,y:o,w:r,h:h}},t.Ratio.fitAround=function(i,e){var a=t.Ratio.decimal(i.w,i.h),s=0,n=0;return 1==a?n=s=e.w>e.h?e.w:e.h:i.w/e.w>i.h/e.h?(n=e.h,s=e.h*(i.w/i.h)):(s=e.w,n=e.w*(i.h/i.w)),{w:s,h:n}},t.Ratio.getElementPosition=function(t){for(var i=0,e=0;t;)i+=t.offsetLeft-t.scrollLeft+t.clientLeft,e+=t.offsetTop-t.scrollTop+t.clientTop,t=t.offsetParent;return{x:i,y:e}},t.Ratio.hashFnv32a=function(t,i){var e,a,s=void 0===i?2166136261:i;for(e=0,a=t.length;e<a;e++)s^=t.charCodeAt(e),s+=(s<<1)+(s<<4)+(s<<7)+(s<<8)+(s<<24);return("0000000"+(s>>>0).toString(16)).substr(-8)},t.Ratio.areaCoverage=function(t,i,e,a){return Math.round(100*(t*i)/(e*a))}}(IMSoftcrop),function(t){t.Base=function(){},t.Base.prototype={},t.Shape=function(i,e){if("undefined"!=typeof e){this.id=i,this.parent=e;var a=e;do{if(a instanceof t.Editor){this.editor=a;break}a=a.parent}while("undefined"!=typeof a);var s=this.editor.getCanvas();if(!s||"CANVAS"!=s.tagName)throw new TypeError("Canvas required");this.canvas=s,this.ctx=s.getContext("2d")}},t.Shape.prototype=Object.create(t.Base.prototype,{id:{writable:!0},editor:{writable:!0},parent:{writable:!0},canvas:{writable:!0},ctx:{writable:!0},_ready:{value:!1,writable:!0},ready:{get:function(){return this._ready},set:function(t){this._ready=t===!0}},x:{value:0,writable:!0},y:{value:0,writable:!0},w:{value:0,writable:!0},h:{value:0,writable:!0},drawX:{value:0,writable:!0},drawY:{value:0,writable:!0},drawW:{value:0,writable:!0},drawH:{value:0,writable:!0},drawXW:{value:0,writable:!0},drawYH:{value:0,writable:!0},getCanvas:{value:function(){return this.canvas}},inArea:{value:function(t){return!!this.ready&&this.inCalculatedArea(t,this.drawX,this.drawY,this.drawW,this.drawH)}},withinCoordinates:{value:function(t,i,e,a,s){return!(t.x<i||t.x>a)&&!(t.y<e||t.y>s)}},inCalculatedArea:{value:function(t,i,e,a,s){return t.x>=i&&t.x<=i+a&&t.y>=e&&t.y<=e+s}},move:{value:function(t){this.x+=Math.round(t.x),this.y+=Math.round(t.y)}},getCoordinates:{value:function(){return{x:this.x,y:this.y}}},getDimensions:{value:function(){return{x:this.x,y:this.y,w:this.w,h:this.h}}},getDimensionsInCanvas:{value:function(t){"undefined"==typeof t&&(t={x:0,y:0});var i=this.editor.getDimensions(),e=this.editor.getZoom(!0);this.drawW=Math.round(this.w*e),this.drawH=Math.round(this.h*e),this.drawX=Math.round((this.x+t.x)*e)+i.margin,this.drawY=Math.round((this.y+t.y)*e)+i.margin,this.drawXW=this.drawX+this.drawW,this.drawYH=this.drawY+this.drawH}}}),t.Shape.prototype.constructor=t.Shape}(IMSoftcrop),function(t){t.Image=function(i,e){t.Shape.call(this,i,e),this.crops=[],this.focusPoints=[]},t.Image.prototype=Object.create(t.Shape.prototype,{src:{value:"string",writable:!0},image:{writable:!0},crops:{writable:!0},focusPoints:{writable:!0},focusArea:{writable:!0},detailData:{writable:!0},detailArea:{writable:!0},load:{value:function(t,i){var e=document.createElement("img"),a=this;e.crossOrigin="*",e.addEventListener("load",function(){a.w=this.naturalWidth,a.h=this.naturalHeight,a.image=this,a.ready=!0,i()},!1),e.src=t,this.src=t}},clear:{value:function(){for(var t=0;t<this.crops.length;t++)this.crops[t]=null;this.crops=[],this.crop=null,this.image=null}},addSoftcrop:{value:function(i,e,a,s,n,o,r,h){var c;if(null!=(c=this.getSoftcrop(i)))return c;var d;return d=null===n||null===o?t.Ratio.fitInto({w:this.w,h:this.h},{w:a,h:s}):{x:n,y:o,w:a,h:s},c=new t.Softcrop(i,this,a,s,d,(!0),r,h),this.crops.push(c),e&&(this.crop=c),c}},getSoftcrop:{value:function(t){for(var i=0;i<this.crops.length;i++)if(this.crops[i].id==t)return this.crops[i];return null}},detectionReady:{value:function(){return"undefined"!=typeof this.detailArea}},getSoftCrops:{value:function(){return this.crops}},setActiveCrop:{value:function(t){this.crop=t}},getSrc:{value:function(){return this.src}},addDetailData:{value:function(t){this.detailData=t;for(var i={point1:{x:t[0].x,y:t[0].y},point2:{x:t[0].x,y:t[0].y}},e=1;e<t.length;e++)t[e].x<i.point1.x?i.point1.x=t[e].x:t[e].x>i.point2.x&&(i.point2.x=t[e].x),t[e].y<i.point1.y?i.point1.y=t[e].y:t[e].y>i.point2.y&&(i.point2.y=t[e].y);this.detailArea=i,this.constrainArea(this.detailArea)}},addFocusPoint:{value:function(t,i){return t.r=i,this.focusPoints.push(t),"undefined"==typeof this.focusArea?void(this.focusArea={point1:{x:t.x-i,y:t.y-i},point2:{x:t.x+i,y:t.y+i}}):(t.x-t.r<this.focusArea.point1.x&&(this.focusArea.point1.x=t.x-t.r),t.x+t.r>this.focusArea.point2.x&&(this.focusArea.point2.x=t.x+t.r),t.y-t.r<this.focusArea.point1.y&&(this.focusArea.point1.y=t.y-t.r),t.y+t.r>this.focusArea.point2.y&&(this.focusArea.point2.y=t.y+t.r),void this.constrainArea(this.focusArea))}},constrainArea:{value:function(t){t.point1.x<0&&(t.point1.x=0),t.point2.x>this.w&&(t.point2.x=this.w),t.point1.y<0&&(t.point1.y=0),t.point2.y>this.h&&(t.point2.y=this.h)}},redraw:{value:function(i){this.ready&&(this.getDimensionsInCanvas({x:0,y:0}),this.ctx.drawImage(this.image,this.drawX,this.drawY,this.drawW,this.drawH),"object"==typeof i&&i.focuspoints===!0&&this.drawFocusPoints(),this.crop instanceof t.Softcrop&&this.crop.redraw(i))}},drawFocusPoints:{value:function(){if("undefined"!=typeof this.detailArea){this.drawArea(this.detailArea,"rgba(255, 121, 255, 0.4)"),this.ctx.fillStyle="rgba(255, 121, 255, 0.5)";for(var t=0;t<this.detailData.length;t++){var i=this.editor.imagePointInCanvas(this.detailData[t].x,this.detailData[t].y);this.ctx.fillRect(i.x,i.y-3,6,6)}}if("undefined"!=typeof this.focusArea){this.drawArea(this.focusArea,"rgba(121, 121, 255, 0.4)");for(var e=0;e<this.focusPoints.length;e++){var a=this.editor.imagePointInCanvas(this.focusPoints[e].x,this.focusPoints[e].y),s=this.editor.imageLineInCanvas(this.focusPoints[e].r);this.ctx.beginPath(),this.ctx.fillStyle="rgba(255, 255, 255, 0.5)",this.ctx.lineWidth=1,this.ctx.arc(a.x,a.y,s,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.closePath()}}}},drawArea:{value:function(t,i){var e=this.editor.imagePointInCanvas(t.point1.x,t.point1.y),a=this.editor.imagePointInCanvas(t.point2.x,t.point2.y);this.ctx.strokeStyle=i,this.ctx.lineWidth=4,this.ctx.strokeRect(e.x+2,e.y+2,a.x-e.x-4,a.y-e.y-4)}},autocrop:{value:function(t){if(!this.detectionReady())return!1;for(var i="undefined"!=typeof t?new Array(t):this.crops,e=0;e<i.length;e++)i[e].locked||this.autoCropCrop(i[e]);return!0}},autoCropCrop:{value:function(i){var e=this.detailArea,a="undefined"!=typeof this.focusArea?this.focusArea:this.detailArea,s=e.point1.x<a.point1.x?e.point1.x:a.point1.x,n=e.point2.x>a.point2.x?e.point2.x:a.point2.x,o=e.point1.y<a.point1.x?e.point1.y:a.point1.y,r=e.point2.y>a.point2.y?e.point2.y:a.point2.y,h={point1:{x:s>0?s:0,y:o>0?o:0},point2:{x:n<this.w?n:this.w,y:r<this.h?r:this.h}},c=t.Ratio.fitAround({w:i.ratio.w,h:i.ratio.h},{w:h.point2.x-h.point1.x,h:h.point2.y-h.point1.y});c.w<=this.w&&c.h<=this.h?(i.w=c.w,i.h=c.h):c.w>this.w?(i.w=this.w,i.h=t.Ratio.height(this.w,i.ratio.f),i.autoCropWarning=!0):c.h>this.h?(i.h=this.h,i.w=t.Ratio.width(this.h,i.ratio.f),i.autoCropWarning=!0):(console.log("Too wide and too high, how?!? Ignoring!"),i.autoCropWarning=!0);var d={x:h.point1.x+(h.point2.x-h.point1.x)/2,y:h.point1.y+(h.point2.y-h.point1.y)/2},l={x:a.point1.x+(a.point2.x-a.point1.x)/2,y:a.point1.y+(a.point2.y-a.point1.y)/2},u={x:i.x+i.w/2,y:i.y+i.h/2},g=d.x-u.x,p=d.y-u.y;if(i.autoCropWarning){var f=l.y-u.y;p=i.y+f<h.point1.y?h.point1.y-i.y:i.y+i.h+f>h.point2.y?h.point2.y-i.h-i.y:f;var m=l.x-u.x;g=i.x+m<h.point1.x?h.point1.x-i.x:i.x+i.w+m>h.point2.x?h.point2.x-i.w-i.x:m,i.w>=a.point2.x-a.point1.x&&i.h>=a.point2.y-a.point1.y&&.8<=i.w/(h.point2.x-h.point1.x)&&.8<=i.h/(h.point2.y-h.point1.y)&&(i.autoCropWarning=!1)}i.x+g<0?i.x=0:i.x+g+i.w>this.w?i.x=this.w-i.w:i.x+=g,i.y+p<0?i.y=0:i.y+p+i.h>this.h?i.y=this.h-i.h:i.y+=p}}})}(IMSoftcrop),function(t){t.Softcrop=function(i,e,a,s,n,o,r,h){t.Shape.call(this,i,e),this.x=n.x,this.y=n.y,this.w=n.w,this.h=n.h,this.usable=!!h,this.locked=!!r,this.respectRatio=o,this.ratio={w:a,h:s,f:t.Ratio.decimal(a,s)},this.handles={nw:[0,0,0],n:[0,0,0],ne:[0,0,0],e:[0,0,0],se:[0,0,0],s:[0,0,0],sw:[0,0,0],w:[0,0,0]},this.ready=!0},t.Softcrop.prototype=Object.create(t.Shape.prototype,{lineWidth:{value:1},lineColor:{value:"rgba(255, 255, 255, 1)"},lineColorActive:{value:"rgba(0, 255, 255, 1)"},handleThickness:{value:3},handleLength:{value:14},handles:{writable:!0},handle:{writable:!0},ratio:{writable:!0},respectRatio:{value:!0,writable:!0},autoCropWarning:{value:!1,writable:!0},locked:{value:!1,writable:!0},usable:{writable:!0},dragHandle:{value:function(i,e){if("string"==typeof this.handle){var a=this.parent.getDimensions(),s=this.x,n=this.y,o=this.w,r=this.h;switch(i){case"n":n+=e.y,r-=e.y,o=t.Ratio.width(r,this.ratio.f),s+=t.Ratio.width(e.y/2,this.ratio.f);break;case"e":o+=e.x,r=t.Ratio.height(o,this.ratio.f),n-=t.Ratio.height(e.x/2,this.ratio.f);break;case"s":r+=e.y,o=t.Ratio.width(r,this.ratio.f),s-=t.Ratio.width(e.y/2,this.ratio.f);break;case"w":o-=e.x,s+=e.x,r=t.Ratio.height(o,this.ratio.f),n+=t.Ratio.height(e.x/2,this.ratio.f);break;case"nw":Math.abs(e.x)>Math.abs(e.y)?(o-=e.x,s+=e.x,r-=t.Ratio.height(e.x,this.ratio.f),n+=t.Ratio.height(e.x,this.ratio.f)):(r-=e.y,n+=e.y,o-=t.Ratio.width(e.y,this.ratio.f),s+=t.Ratio.width(e.y,this.ratio.f));break;case"ne":Math.abs(e.x)>Math.abs(e.y)?(o+=e.x,r+=t.Ratio.height(e.x,this.ratio.f),n-=t.Ratio.height(e.x,this.ratio.f)):(o-=t.Ratio.width(e.y,this.ratio.f),r-=e.y,n+=e.y);break;case"se":Math.abs(e.x)>Math.abs(e.y)?(o+=e.x,r+=t.Ratio.height(e.x,this.ratio.f)):(r+=e.y,o+=t.Ratio.width(e.y,this.ratio.f));break;case"sw":Math.abs(e.x)>Math.abs(e.y)?(o-=e.x,s+=e.x,r-=t.Ratio.height(e.x,this.ratio.f)):(o+=t.Ratio.width(e.y,this.ratio.f),s-=t.Ratio.width(e.y,this.ratio.f),r+=e.y)}r<40||o<40||o>a.w||r>a.h||s+o>a.w||n+r>a.h||(s<0&&(s=0),n<0&&(n=0),this.x=Math.round(s),this.y=Math.round(n),this.w=Math.round(o),this.h=Math.round(r))}}},move:{value:function(i){var e=this.parent.getDimensions();return this.x+i.x<0&&(this.x=0,i.x=0),this.y+i.y<0&&(i.y=0,this.y=0),this.w+this.x+Math.round(i.x)>e.w?void(i.x=e.w-this.w):this.h+this.y+Math.round(i.y)>e.h?void(i.y=e.h-this.h):void t.Shape.prototype.move.call(this,i)}},overHandle:{value:function(t){var i="",e=this.overVerticalArea(t),a=this.overHorizontalArea(t);return!a&&!e||a&&e?a==e?i="":(i=a+e,i=i.replace("m","")):i="",""===i?this.handle=!1:this.handle=i,this.handle}},overHorizontalArea:{value:function(t){var i=this.drawX-this.handleThickness,e=this.drawX+this.drawW+this.handleThickness;return this.withinCoordinates(t,i,this.drawY+this.drawH-this.handleLength+this.handleThickness,e,this.drawY+this.drawH+this.handleThickness)?"s":this.withinCoordinates(t,i,this.drawY+this.drawH/2-this.handleLength,e,this.drawY+this.drawH/2+this.handleLength)?"m":this.withinCoordinates(t,i,this.drawY-this.handleThickness,e,this.drawY+this.handleLength)?"n":""}},overVerticalArea:{value:function(t){var i=this.drawY-this.handleThickness,e=this.drawY+this.drawH+this.handleThickness;return this.withinCoordinates(t,this.drawX+this.drawW-this.handleLength,i,this.drawX+this.drawW+this.handleThickness,e)?"e":this.withinCoordinates(t,this.drawX+this.drawW/2-this.handleLength,i,this.drawX+this.drawW/2+this.handleLength,e)?"m":this.withinCoordinates(t,this.drawX-this.handleThickness,i,this.drawX+this.handleLength,e)?"w":""}},redraw:{value:function(t){if(this.ready){this.getDimensionsInCanvas(this.parent.getCoordinates()),this.drawCropMargins();var i=2*this.handleLength;this.ctx.beginPath(),this.drawHandle("nw",!1,this.drawX,this.drawY,this.handleLength,this.handleThickness),this.drawHandle("se",!1,this.drawXW,this.drawYH,this.handleLength,this.handleThickness),this.drawHandle("ne",!1,this.drawXW,this.drawY,this.handleLength,this.handleThickness),
this.drawHandle("sw",!1,this.drawX,this.drawYH,this.handleLength,this.handleThickness);var e=this.drawW/2,a=this.drawH/2;this.drawHandle("n",!1,this.drawX+e,this.drawY,i,this.handleThickness),this.drawHandle("e",!1,this.drawXW,this.drawY+a,i,this.handleThickness),this.drawHandle("s",!1,this.drawX+e,this.drawYH,i,this.handleThickness),this.drawHandle("w",!1,this.drawX,this.drawY+a,i,this.handleThickness),this.ctx.stroke(),this.ctx.closePath(),this.drawCropBorder(),"object"==typeof t&&t.guides===!0&&(this.drawCropGuidelines(0,"rgba(55, 55, 55, 0.25)"),this.drawCropGuidelines(-.5,"rgba(255, 255, 255, 0.5)"))}}},drawCropGuidelines:{value:function(t,i){this.ctx.closePath(),this.ctx.beginPath(),this.ctx.setLineDash&&this.ctx.setLineDash([3,3]),this.ctx.strokeStyle=i,this.ctx.lineWidth=1;var e=this.drawH/3,a=this.drawW/3;this.ctx.moveTo(this.drawX,t+this.drawY+e),this.ctx.lineTo(this.drawX+this.drawW,t+this.drawY+e),this.ctx.moveTo(this.drawX,t+this.drawY+e+e),this.ctx.lineTo(this.drawX+this.drawW,t+this.drawY+e+e),this.ctx.moveTo(t+this.drawX+a,this.drawY),this.ctx.lineTo(t+this.drawX+a,this.drawY+this.drawH),this.ctx.moveTo(t+this.drawX+a+a,this.drawY),this.ctx.lineTo(t+this.drawX+a+a,this.drawY+this.drawH),this.ctx.stroke(),this.ctx.setLineDash&&this.ctx.setLineDash([]),this.ctx.closePath()}},drawCropBorder:{value:function(){this.ctx.beginPath(),this.ctx.strokeStyle="rgba(0, 0, 0, 0.3)",this.ctx.lineWidth=1,this.ctx.rect(this.drawX-.5,this.drawY-.5,this.drawW+1,this.drawH+1),this.ctx.stroke(),this.ctx.closePath()}},drawCropMargins:{value:function(){this.ctx.beginPath(),this.ctx.fillStyle="rgba(0, 0, 0, 0.3)",this.ctx.rect(0,0,this.canvas.width,this.drawY),this.ctx.rect(0,0,this.drawX,this.canvas.height),this.ctx.rect(this.drawX,this.drawYH,this.canvas.width,this.canvas.height),this.ctx.rect(this.drawXW,this.drawY,this.canvas.width,this.drawH),this.ctx.fill(),this.ctx.closePath()}},drawHandle:{value:function(t,i,e,a,s,n){var o=n/2,r=s/2;switch(this.ctx.lineWidth=n,this.ctx.strokeStyle=i?this.lineColorActive:this.lineColor,t){case"se":o*=-1,s*=-1;case"nw":this.ctx.moveTo(e-o,a+s),this.ctx.lineTo(e-o,a-o),this.ctx.lineTo(e+s,a-o),this.handles[t]=[e,a,n,s];break;case"sw":o*=-1,s*=-1;case"ne":this.ctx.moveTo(e-s,a-o),this.ctx.lineTo(e+o,a-o),this.ctx.lineTo(e+o,a+s),this.handles[t]=[e,a,n,s];break;case"n":this.ctx.moveTo(e-r,a-o),this.ctx.lineTo(e+r,a-o);break;case"s":this.ctx.moveTo(e-r,a+o),this.ctx.lineTo(e+r,a+o);break;case"w":this.ctx.moveTo(e-o,a+r),this.ctx.lineTo(e-o,a-r);break;case"e":this.ctx.moveTo(e+o,a+r),this.ctx.lineTo(e+o,a-r)}}}}),t.Softcrop.prototype.constructor=t.Softcrop}(IMSoftcrop);