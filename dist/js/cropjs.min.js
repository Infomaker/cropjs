/**
 * cropjs - Infomaker image auto cropper. (c) Infomaker
 * @author Danne Lundqvist
 * @version v0.0.1
 * @link http://www.infomaker.se
 * @license Unlicense
 */
!function(){this.IMCropUI=function(){},IMCropUI.Toggle=function(t,i){var e,a=t,o=!1,s=i,n=this;if(e=document.getElementById(a),!e)return void console.log("Element not found: "+a);e.classList.contains("on")&&(o=!0);var h=e.getElementsByTagName("em");1==h.length&&h[0].classList.contains("hint")&&(e.title=h[0].innerHTML),Object.defineProperty(this,"on",{get:function(){return o},set:function(t){o=t,t&&!e.classList.contains("on")?e.classList.add("on"):!t&&e.classList.contains("on")&&e.classList.remove("on")}}),e.addEventListener("click",function(t){return this.classList.toggle("on"),t.preventDefault(),t.stopPropagation(),o=this.classList.contains("on"),"function"==typeof s&&s.call(n,t),!1})},IMCropUI.Button=function(t,i){var e,a=t,o=i,s=this;return(e=document.getElementById(a))?void e.addEventListener("click",function(t){return t.preventDefault(),t.stopPropagation(),"function"==typeof o&&o.call(s,t),!1}):void console.log("Element not found: "+a)}}();var IMSoftcrop=function(){return this.Editor=function(t,i){if(this._id=t,this.setupUI(),this.adjustForPixelRatio(),this.calculateViewport(),this.addCanvasEventListeners(),this.setupAnimation(),this.runAnimation(),"object"==typeof i){var e=this;i.debug===!0&&("undefined"!=typeof i.debug&&(this._debugContainer=i.debugElement),this._debug=!0),i.autocrop===!0&&(this._autocrop=!0),"number"==typeof i.detectThreshold&&(this._detectThreshold=i.detectThreshold),"number"==typeof i.detectStepSize&&(this._detectStepSize=!0)}this._cropLockedToggle=new IMCropUI.Toggle("imc_croplocked",function(){e._crop instanceof IMSoftcrop.Softcrop&&(e._crop.locked=this.on)}),this._guidesToggle=new IMCropUI.Toggle("imc_guides",function(){e.redraw()}),this._focusPointsToggle=new IMCropUI.Toggle("imc_focuspoints",function(){e.redraw()}),this._saveButton=new IMCropUI.Button("imc_save",function(){e.onButtonSave()}),this._cancelButton=new IMCropUI.Button("imc_cancel",function(){e.onButtonCancel()})},this.Editor.prototype={_id:"",_container:void 0,_canvas:void 0,_ctx:void 0,_redrawCanvas:!1,_previewContainer:void 0,_debugContainer:void 0,_image:void 0,_crops:[],_crop:void 0,handle:void 0,_dragObject:void 0,_dragPoint:void 0,_position:{x:0,y:0},_zoomLevel:1,_keepCenter:!1,_scale:1,_margin:5,_zoomMax:5,_zoomMin:.1,_autocrop:!1,_detectThreshold:60,_detectStepSize:1.6,_debug:!1,_onSave:void 0,_onCancel:void 0,_guidesToggle:void 0,_focusPointsToggle:void 0,_cropLockedToggle:void 0,_saveButton:void 0,_cancelButton:void 0,setupUI:function(){if(this._container=document.getElementById(this._id),!this._container)throw new Error("Container element with id <"+this._id+"> not found");if(this._previewContainer=document.getElementById("imc_preview_container"),!this._previewContainer)throw new Error("Preview element with id <imc_preview_container> not found");if(this._canvas=document.getElementById("imc_canvas"),!this._canvas)throw new Error("Canvas element with id <imc_canvas_initial> not found");this._ctx=this._canvas.getContext("2d")},setupAnimation:function(){for(var t=0,i=["webkit","moz"],e=0;e<i.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[i[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[i[e]+"CancelAnimationFrame"]||window[i[e]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(i,e){var a=(new Date).getTime(),o=Math.max(0,16-(a-t)),s=window.setTimeout(function(){i(a+o)},o);return t=a+o,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})},runAnimation:function(){var t=this;requestAnimationFrame(function(){t.runAnimation()}),this._redrawCanvas&&(this._redrawCanvas=!1,this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._image instanceof IMSoftcrop.Image&&(this._image.redraw({guides:this._guidesToggle.on,focuspoints:this._focusPointsToggle.on}),this._crop instanceof IMSoftcrop.Softcrop&&this._renderUpdatedPreview(this._crop)),this._debug&&this._renderDebug())},redraw:function(){this._redrawCanvas=!0},toggleLoadingImage:function(t){var i=document.getElementById("imc_loading");return"undefined"==typeof t?i.classList.contains("loading"):(t?i.classList.add("loading"):i.classList.remove("loading"),t)},_renderNewCropPreview:function(t,i){var e=80,a=this,o=document.createElement("div");o.id=this._image.id+"_"+t.id,o.classList.add("imc_preview_image_container"),i&&o.classList.add("active"),o.addEventListener("click",function(){a.setActiveCrop(t)});var s=document.createElement("div");s.classList.add("imc_preview_image"),s.style.width=IMSoftcrop.Ratio.width(e,t.ratio.f)+"px";var n=document.createElement("span"),h=document.createTextNode(t.id),r=document.createElement("i");r.className="fa fa-warning",n.appendChild(h),n.appendChild(r);var c=document.createElement("img");c.src=this._image.src,s.appendChild(c),s.appendChild(n),o.appendChild(s),this._previewContainer.appendChild(o),this._renderUpdatedPreview(t)},_renderUpdatedPreview:function(t){var i=document.getElementById(this._image.id+"_"+t.id);if(null!=i&&"object"==typeof i){var e=this._image.getDimensions(),a=80,o=IMSoftcrop.Ratio.width(a,t.ratio.f),s=t.getDimensions(),n=o/s.w,h=i.getElementsByTagName("IMG");h[0].style.height=e.h*n+"px",h[0].style.marginTop="-"+s.y*n+"px",h[0].style.marginLeft="-"+s.x*n+"px",1==t.autoCropWarning?i.classList.add("warning"):i.classList.remove("warning")}},getDimensions:function(){return{margin:this._margin,width:this._canvas.width,height:this._canvas.height}},adjustForPixelRatio:function(t){var i=t||this._canvas,e=i.getContext("2d"),a=window.devicePixelRatio||1,o=e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1,s=a/o;if(a!==o){var n=this._container.clientWidth,h=this._container.clientHeight;i.width=n*s,i.height=h*s,i.style.width=n+"px",i.style.height=h+"px",e.scale(s,s),this._scale=s}else i.width=this._container.clientWidth,i.height=this._container.clientHeight},addImage:function(t,i){var e=this;this.toggleLoadingImage(!0),this.clear(),this._image=new IMSoftcrop.Image(IMSoftcrop.Ratio.hashFnv32a(t),this),this._image.load(t,function(){e.setZoomToImage(!1),e.centerImage(!1),e._autocrop?(e.detectDetails(),e.detectFaces()):e.toggleLoadingImage(!1),e.applySoftcrops(),e.redraw(),"function"==typeof i&&i.call(e,e._image)})},addSoftcrop:function(t,i,e){this._crops.push({id:t+":"+i,hRatio:t,vRatio:i,setAsCurrent:e}),this._image instanceof IMSoftcrop.Image&&this._image.ready&&this.applySoftcrops()},applySoftcrops:function(){if(this._image instanceof IMSoftcrop.Image!=0&&this._image.ready)for(var t=0;t<this._crops.length;t++){var i=this._image.getSoftcrop(this._crops[t].id);if(null==i){var i=this._image.addSoftcrop(this._crops[t].id,this._crops[t].hRatio,this._crops[t].vRatio,this._crops[t].setAsCurrent);this._autocrop&&this._image.autocrop(),this._renderNewCropPreview(i,this._crops[t].setAsCurrent)}this._crops[t].setAsCurrent&&this.setActiveCrop(i)}},setActiveCrop:function(t){if(t instanceof IMSoftcrop.Softcrop==!0){for(var i=document.getElementById(this._image.id+"_"+t.id),e=this._previewContainer.getElementsByClassName("imc_preview_image_container"),a=0;a<e.length;a++)e[a].classList.remove("active");i.classList.add("active"),this._crop=t,this._image.setActiveCrop(t),this._cropLockedToggle.on=t.locked,this.redraw()}},clear:function(){this._image instanceof IMSoftcrop.Image!=0&&(this._image.clear(),this._crop=void 0,this._image=void 0,this._previewContainer.innerHTML="",this.redraw())},autocropImages:function(){this._autocrop&&(this.toggleLoadingImage()||this.toggleLoadingImage(!0),this._image.autocrop()&&(this.redraw(),this.toggleLoadingImage(!1)))},getImageData:function(){if(!(!this._image instanceof IMSoftcrop.Image)&&this._image.ready){var t=document.getElementsByTagName("body"),i=document.createElement("canvas"),e=i.getContext("2d");i.style.display="none",t[0].appendChild(i),i.width=this._image.w,i.height=this._image.h,i.style.width=this._image.w+"px",i.style.height=this._image.h+"px",e.drawImage(this._image.image,0,0,this._image.w,this._image.h);var a=e.getImageData(0,0,this._image.w,this._image.h);return e=null,t[0].removeChild(i),i=null,t[0]=null,t=null,a}},detectDetails:function(){if(!(!this._image instanceof IMSoftcrop.Image)&&this._image.ready){var t=this,i=this.getImageData();if(window.Worker){var e=new Worker("js/imcrop.worker.detect.js");e.postMessage(["details",i,this._image.w,this._image.h,this._detectThreshold]),e.onmessage=function(i){t.addDetectedDetails(i.data),t.autocropImages()}}else{var a=tracking.Fast.findCorners(tracking.Image.grayscale(i.data,this._image.w,this._image.h),this._image.w,this._image.h,this._detectThreshold);this.addDetectedDetails(a),this.autocropImages()}}},addDetectedDetails:function(t){for(var i=[],e=0;e<t.length;e+=2)i.push({x:t[e],y:t[e+1]});this._image.addDetailData(i)},detectFaces:function(){if(!(!this._image instanceof IMSoftcrop.Image)&&this._image.ready){var t=this;if(window.Worker){var i=new Worker("js/imcrop.worker.detect.js");i.postMessage(["features",this.getImageData(),this._image.w,this._image.h,this._detectStepSize]),i.onmessage=function(i){t.addDetectedFeature(i.data),t.autocropImages()}}else{tracking.trackData=function(t,i,e,a){var o=new tracking.TrackerTask(t);return o.on("run",function(){t.track(i.data,e,a)}),o.run()};var e=new tracking.ObjectTracker(["face","eye"]);e.setStepSize(this._detectStepSize),e.on("track",function(i){i.data.forEach(function(i){t.addDetectedFeature(i)}),t.autocropImages()}),tracking.trackData(e,this.getImageData(),this._image.w,this._image.h)}}},addDetectedFeature:function(t){var i={x:t.x,y:t.y},e=this.canvasLineInImage(t.width>t.height?t.width/2/this._scale:t.height/2/this._scale);i.x+=e,i.y+=e,this._image.addFocusPoint(i,1.5*e)},canvasLineInImage:function(t){return t/this._zoomLevel},imageLineInCanvas:function(t){return t*this._zoomLevel},imagePointInCanvas:function(t,i){return{x:Math.round((t+this._image.x)*this._zoomLevel)+this._margin,y:Math.round((i+this._image.y)*this._zoomLevel)+this._margin}},canvasPointInImage:function(t,i){return{x:Math.round((t-this._margin)/this._zoomLevel)-this._image.x,y:Math.round((i-this._margin)/this._zoomLevel)-this._image.y}},centerImage:function(t,i,e){var a,o;this._keepCenter=!0,a=this._container.clientWidth/2,o=this._container.clientHeight/2;var s=this._image.w*this._zoomLevel/2+this._image.x*this._zoomLevel+this._margin,n=this._image.h*this._zoomLevel/2+this._image.y*this._zoomLevel+this._margin,h=a==s?0:(a-s)/this._zoomLevel,r=o==n?0:(o-n)/this._zoomLevel;this._image.move({x:h,y:r}),t===!0&&this.redraw()},getZoom:function(t){return t===!0?this._zoomLevel:100*this._zoomLevel},setZoom:function(t,i){this._zoomLevel=t/100,this._keepCenter&&this.centerImage(!1),i===!0&&this.redraw()},setZoomToImage:function(t){var i=this._image.getDimensions(),e=(this._container.clientHeight-2*this._margin)/i.h,a=(this._container.clientWidth-2*this._margin)/i.w;if(a>e&&1>e&&this._zoomLevel>e)this._zoomLevel=e,this.centerImage(!1);else{if(!(1>a&&this._zoomLevel>a))return;this._zoomLevel=a,this.centerImage(!1)}t===!0&&this.redraw()},addCanvasEventListeners:function(){var t=this;window.addEventListener("resize",function(){t.onResize(event)},!1),this._canvas.addEventListener("dblclick",function(i){return t.onDoubleClick(i)}),this._canvas.addEventListener("mousedown",function(i){t.onMouseDown(i)}),this._canvas.addEventListener("mouseup",function(i){t.onMouseUp(i)}),window.addEventListener("mouseup",function(i){t.onMouseUp(i)}),this._canvas.addEventListener("mousemove",function(i){t.onMouseMove(i)}),this._canvas.addEventListener("mousewheel",function(i){return i.stopPropagation(),i.preventDefault(),t.onMouseWheel(i),!1},!1),document.addEventListener("keydown",function(i){var e=i.keyCode||i.which;if(27==e)return t.onCancel(),i.preventDefault(),i.stopPropagation(),!1;if(9==e){for(var a,o=t._image.getCrops(),s=0;s<o.length;s++)if(t._crop===o[s]){a=s;break}return"undefined"!=typeof a&&(s+=i.shiftKey?-1:1,0>s?s=o.length-1:s+1>o.length&&(s=0),t.setActiveCrop(o[s])),i.preventDefault(),i.stopPropagation(),!1}},!1)},onSave:function(t){"function"==typeof t&&(this._onSave=t)},onCancel:function(t){"function"==typeof t&&(this._onCancel=t)},onButtonSave:function(){if("function"!=typeof this._onSave)return void console.log("User save function not defined");for(var t={src:this._image.src,width:this._image.w,height:this._image.h,crops:[]},i=0;i<this._image.crops.length;i++)t.crops.push({name:this._image.crops[i].id,x:Math.round(this._image.crops[i].x),y:Math.round(this._image.crops[i].y),width:Math.round(this._image.crops[i].w),height:Math.round(this._image.crops[i].h)});this._onSave(t)},onButtonCancel:function(){return"function"!=typeof this._onSave?void console.log("User cancel function not defined"):void this._onCancel()},onResize:function(){this._keepCenter&&this.centerImage(!1),this.redraw(),this.calculateViewport()},onDoubleClick:function(t){if(t.preventDefault(),t.stopPropagation(),"undefined"==typeof this._image)return!1;this.toggleLoadingImage(!0),this._focusPointsToggle.on||(this._focusPointsToggle.on=!0);var i=this.getMousePoint(t);return this._image.addFocusPoint(this.canvasPointInImage(i.x,i.y),40),this._image.autocrop()&&(this.redraw(),this.toggleLoadingImage(!1)),!1},onMouseDown:function(t){var i=this.getMousePoint(t);this._crop instanceof IMSoftcrop.Softcrop&&"string"==typeof this.handle?(this._dragPoint=i,this._dragObject=this.handle):this._crop instanceof IMSoftcrop.Softcrop&&this._crop.inArea(i)?(this._dragObject=this._crop,this._dragPoint=i):this._image instanceof IMSoftcrop.Image&&this._image.inArea(i)&&(this._dragObject=this._image,this._dragPoint=i)},onMouseUp:function(){this._dragObject=void 0,this._dragPoint=void 0},onMouseMove:function(t){var i=this.getMousePoint(t);if("undefined"!=typeof this._dragObject)return"string"==typeof this._dragObject?this._crop.dragHandle(this._dragObject,{x:(i.x-this._dragPoint.x)/this._zoomLevel,y:(i.y-this._dragPoint.y)/this._zoomLevel}):(this._dragObject instanceof IMSoftcrop.Image&&(this._keepCenter=!1),this._dragObject.move({x:(i.x-this._dragPoint.x)/this._zoomLevel,y:(i.y-this._dragPoint.y)/this._zoomLevel})),this.redraw(),void(this._dragPoint=i);if(this._crop instanceof IMSoftcrop.Softcrop){var e=this._crop.overHandle(i);if(e!==!1&&this.handle!=e)return this._canvas.style.cursor="nw"==e||"se"==e?"nwse-resize":"ne"==e||"sw"==e?"nesw-resize":"n"==e||"s"==e?"ns-resize":"ew-resize",void(this.handle=e);if(e===!1&&this.handle)return this._canvas.style.cursor="default",void(this.handle=void 0);if(this.handle)return}return this._image instanceof IMSoftcrop.Image&&this._image.inArea(i)?void(this._canvas.style.cursor="move"):void(this._canvas.style.cursor="default")},onMouseWheel:function(t){var i=(this.getMousePoint(t),Math.max(-1,Math.min(1,t.wheelDelta||-t.detail))),e=0,a=this._zoomLevel;if(0>i&&this._zoomLevel<this._zoomMax)e=this._zoomLevel<1?.01:.03,this._zoomLevel+=e;else{if(!(i>0&&this._zoomLevel>this._zoomMin))return;e=this._zoomLevel<1?-.01:-.03,this._zoomLevel+=e}var o=this._image.w*a-this._image.w*this._zoomLevel,s=this._image.h*a-this._image.h*this._zoomLevel;this._image.move({x:o/2,y:s/2}),this.redraw()},getMousePoint:function(t){return{x:t.pageX-this._position.x,y:t.pageY-this._position.y}},getCanvas:function(){return this._canvas},calculateViewport:function(){var t=IMSoftcrop.Ratio.getElementPosition(this._canvas);this._position.x=t.x,this._position.y=t.y},_renderDebug:function(){if(this._drawCross("red",{x:this._container.clientWidth/2,y:this._container.clientHeight/2}),this._drawCross("green",{x:this._image.w*this._zoomLevel/2+this._image.x*this._zoomLevel+this._margin,y:this._image.h*this._zoomLevel/2+this._image.y*this._zoomLevel+this._margin}),"undefined"!=typeof this._debugContainer){var t="<pre>";t+="Zoom level: "+this._zoomLevel+"\n","undefined"!=typeof this._image&&(t+="Image w: "+this._image.w+"\n",t+="      h: "+this._image.h+"\n",t+="\n","undefined"!=typeof this._image.crop&&(t+="Crop  x: "+this._image.crop.x+"\n",t+="      y: "+this._image.crop.y+"\n",t+="      w: "+this._image.crop.w+"\n",t+="      h: "+this._image.crop.h+"\n")),t+="</pre>",this._debugContainer.innerHTML=t}},_drawCross:function(t,i){var e=this._canvas.getContext("2d");e.beginPath(),e.fillStyle=t,e.strokeStyle=t,e.lineWidth=.5,e.arc(i.x,i.y,5,0,2*Math.PI,!1),e.fill(),e.beginPath(),e.moveTo(i.x-50,i.y),e.lineTo(i.x+50,i.y),e.stroke(),e.beginPath(),e.moveTo(i.x,i.y-50),e.lineTo(i.x,i.y+50),e.stroke()}},this}();!function(t){t.Ratio=function(){},t.Ratio.decimal=function(t,i){return i/t},t.Ratio.height=function(t,i){return Math.round(t*i)},t.Ratio.width=function(t,i){return Math.round(t/i)},t.Ratio.fitInto=function(i,e){var a=t.Ratio.decimal(e.w,e.h),o=t.Ratio.decimal(i.w,i.h),s=0,n=0,h=i.w,r=i.h;return o>a?(r=t.Ratio.height(h,a),n=(i.h-r)/2):(h=t.Ratio.width(r,a),s=(i.w-h)/2),{x:s,y:n,w:h,h:r}},t.Ratio.fitAround=function(i,e){var a=t.Ratio.decimal(i.w,i.h),o=0,s=0;return 1==a?s=o=e.w>e.h?e.w:e.h:i.w/e.w>i.h/e.h?(s=e.h,o=e.h*(i.w/i.h)):(o=e.w,s=e.w*(i.h/i.w)),{w:o,h:s}},t.Ratio.getElementPosition=function(t){for(var i=0,e=0;t;)i+=t.offsetLeft-t.scrollLeft+t.clientLeft,e+=t.offsetTop-t.scrollTop+t.clientTop,t=t.offsetParent;return{x:i,y:e}},t.Ratio.hashFnv32a=function(t,i){var e,a,o=void 0===i?2166136261:i;for(e=0,a=t.length;a>e;e++)o^=t.charCodeAt(e),o+=(o<<1)+(o<<4)+(o<<7)+(o<<8)+(o<<24);return("0000000"+(o>>>0).toString(16)).substr(-8)},t.Ratio.areaCoverage=function(t,i,e,a){return Math.round(100*t*i/(e*a))}}(IMSoftcrop),function(t){t.Base=function(){},t.Base.prototype={},t.Shape=function(i,e){this.id=i,this.parent=e;var a=e;do{if(a instanceof t.Editor){this.editor=a;break}a=a.parent}while("undefined"!=typeof a);var o=this.editor.getCanvas();if(!o||"CANVAS"!=o.tagName)throw new TypeError("Canvas required");this.canvas=o,this.ctx=o.getContext("2d")},t.Shape.prototype=Object.create(t.Base.prototype,{id:{writable:!0},editor:{writable:!0},parent:{writable:!0},canvas:{writable:!0},ctx:{writable:!0},_ready:{value:!1,writable:!0},ready:{get:function(){return this._ready},set:function(t){this._ready=t===!0}},x:{value:0,writable:!0},y:{value:0,writable:!0},w:{value:0,writable:!0},h:{value:0,writable:!0},drawX:{value:0,writable:!0},drawY:{value:0,writable:!0},drawW:{value:0,writable:!0},drawH:{value:0,writable:!0},drawXW:{value:0,writable:!0},drawYH:{value:0,writable:!0},getCanvas:{value:function(){return this.canvas}},inArea:{value:function(t){return this.ready?this.inCalculatedArea(t,this.drawX,this.drawY,this.drawW,this.drawH):!1}},withinCoordinates:{value:function(t,i,e,a,o){return t.x<i||t.x>a?!1:t.y<e||t.y>o?!1:!0}},inCalculatedArea:{value:function(t,i,e,a,o){return t.x>=i&&t.x<=i+a&&t.y>=e&&t.y<=e+o?!0:!1}},move:{value:function(t){this.x+=Math.round(t.x),this.y+=Math.round(t.y)}},getCoordinates:{value:function(){return{x:this.x,y:this.y}}},getDimensions:{value:function(){return{x:this.x,y:this.y,w:this.w,h:this.h}}},getDimensionsInCanvas:{value:function(t){"undefined"==typeof t&&(t={x:0,y:0});var i=this.editor.getDimensions(),e=this.editor.getZoom(!0);this.drawW=Math.round(this.w*e),this.drawH=Math.round(this.h*e),this.drawX=Math.round((this.x+t.x)*e)+i.margin,this.drawY=Math.round((this.y+t.y)*e)+i.margin,this.drawXW=this.drawX+this.drawW,this.drawYH=this.drawY+this.drawH}}}),t.Shape.prototype.constructor=t.Shape}(IMSoftcrop),function(t){t.Image=function(i,e){t.Shape.call(this,i,e),this.crops=[],this.focusPoints=[]},t.Image.prototype=Object.create(Shape.prototype,{src:{value:"string",writable:!0},image:{writable:!0},crops:{writable:!0},focusPoints:{writable:!0},focusArea:{writable:!0},detailData:{writable:!0},detailArea:{writable:!0},load:{value:function(t,i){var e=document.createElement("img"),a=this;e.crossOrigin="*",e.addEventListener("load",function(){a.w=this.naturalWidth,a.h=this.naturalHeight,a.image=this,a.ready=!0,i()},!1),e.src=t,this.src=t}},clear:{value:function(){for(var t=0;t<this.crops.length;t++)this.crops[t]=null;this.crops=[],this.crop=null,this.image=null}},addSoftcrop:{value:function(i,e,a,o){var s;if(null!=(s=this.getSoftcrop(i)))return s;var n=t.Ratio.fitInto({w:this.w,h:this.h},{w:e,h:a});return s=new t.Softcrop(i,this,e,a,n,!0),this.crops.push(s),o&&(this.crop=s),s}},getSoftcrop:{value:function(t){for(var i=0;i<this.crops.length;i++)if(this.crops[i].id==t)return this.crops[i];return null}},detectionReady:{value:function(){return"undefined"!=typeof this.detailArea&&"undefined"!=typeof this.focusArea}},getCrops:{value:function(){return this.crops}},setActiveCrop:{value:function(t){this.crop=t}},getSrc:{value:function(){return this.src}},addDetailData:{value:function(t){this.detailData=t;for(var i={point1:{x:t[0].x,y:t[0].y},point2:{x:t[0].x,y:t[0].y}},e=1;e<t.length;e++)t[e].x<i.point1.x?i.point1.x=t[e].x:t[e].x>i.point2.x&&(i.point2.x=t[e].x),t[e].y<i.point1.y?i.point1.y=t[e].y:t[e].y>i.point2.y&&(i.point2.y=t[e].y);this.detailArea=i,this.constrainArea(this.detailArea)}},addFocusPoint:{value:function(t,i){return t.r=i,this.focusPoints.push(t),"undefined"==typeof this.focusArea?void(this.focusArea={point1:{x:t.x-i,y:t.y-i},point2:{x:t.x+i,y:t.y+i}}):(t.x-t.r<this.focusArea.point1.x&&(this.focusArea.point1.x=t.x-t.r),t.x+t.r>this.focusArea.point2.x&&(this.focusArea.point2.x=t.x+t.r),t.y-t.r<this.focusArea.point1.y&&(this.focusArea.point1.y=t.y-t.r),t.y+t.r>this.focusArea.point2.y&&(this.focusArea.point2.y=t.y+t.r),void this.constrainArea(this.focusArea))}},constrainArea:{value:function(t){t.point1.x<0&&(t.point1.x=0),t.point2.x>this.w&&(t.point2.x=this.w),t.point1.y<0&&(t.point1.y=0),t.point2.y>this.h&&(t.point2.y=this.h)}},redraw:{value:function(i){this.ready&&(this.getDimensionsInCanvas({x:0,y:0}),this.ctx.drawImage(this.image,this.drawX,this.drawY,this.drawW,this.drawH),"object"==typeof i&&i.focuspoints===!0&&this.drawFocusPoints(),this.crop instanceof t.Softcrop&&this.crop.redraw(i))}},drawFocusPoints:{value:function(){if("undefined"!=typeof this.detailArea){this.drawArea(this.detailArea,"rgba(255, 121, 255, 0.4)"),this.ctx.fillStyle="rgba(255, 121, 255, 0.5)";for(var t=0;t<this.detailData.length;t++){var i=this.editor.imagePointInCanvas(this.detailData[t].x,this.detailData[t].y);this.ctx.fillRect(i.x,i.y-3,6,6)}}if("undefined"!=typeof this.focusArea){this.drawArea(this.focusArea,"rgba(121, 121, 255, 0.4)");for(var e=0;e<this.focusPoints.length;e++){var a=this.editor.imagePointInCanvas(this.focusPoints[e].x,this.focusPoints[e].y),o=this.editor.imageLineInCanvas(this.focusPoints[e].r);this.ctx.beginPath(),this.ctx.fillStyle="rgba(255, 255, 255, 0.5)",this.ctx.lineWidth=1,this.ctx.arc(a.x,a.y,o,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.closePath()}}}},drawArea:{value:function(t,i){var e=this.editor.imagePointInCanvas(t.point1.x,t.point1.y),a=this.editor.imagePointInCanvas(t.point2.x,t.point2.y);this.ctx.strokeStyle=i,this.ctx.lineWidth=4,this.ctx.strokeRect(e.x+2,e.y+2,a.x-e.x-4,a.y-e.y-4)}},autocrop:{value:function(t){if(!this.detectionReady())return!1;for(var i="undefined"!=typeof t?new Array(t):this.crops,e=0;e<i.length;e++)this.autoCropCrop(i[e]);return!0}},autoCropCrop:{value:function(i){var e=this.detailArea.point1.x<this.focusArea.point1.x?this.detailArea.point1.x:this.focusArea.point1.x,a=this.detailArea.point2.x>this.focusArea.point2.x?this.detailArea.point2.x:this.focusArea.point2.x,o=this.detailArea.point1.y<this.focusArea.point1.x?this.detailArea.point1.y:this.focusArea.point1.y,s=this.detailArea.point2.y>this.focusArea.point2.y?this.detailArea.point2.y:this.focusArea.point2.y,n={point1:{x:e>0?e:0,y:o>0?o:0},point2:{x:a<this.w?a:this.w,y:s<this.h?s:this.h}},h=t.Ratio.fitAround({w:i.ratio.w,h:i.ratio.h},{w:n.point2.x-n.point1.x,h:n.point2.y-n.point1.y});h.w<=this.w&&h.h<=this.h?(i.w=h.w,i.h=h.h):h.w>this.w?(i.w=this.w,i.h=t.Ratio.height(this.w,i.ratio.f),i.autoCropWarning=!0):h.h>this.h?(i.h=this.h,i.w=t.Ratio.width(this.h,i.ratio.f),i.autoCropWarning=!0):(console.log("Too wide and too high, how?!? Ignoring!"),i.autoCropWarning=!0);var r={x:n.point1.x+(n.point2.x-n.point1.x)/2,y:n.point1.y+(n.point2.y-n.point1.y)/2},c={x:this.focusArea.point1.x+(this.focusArea.point2.x-this.focusArea.point1.x)/2,y:this.focusArea.point1.y+(this.focusArea.point2.y-this.focusArea.point1.y)/2},d={x:i.x+i.w/2,y:i.y+i.h/2},l=r.x-d.x,u=r.y-d.y;if(i.autoCropWarning){var g=c.y-d.y;u=i.y+g<n.point1.y?n.point1.y-i.y:i.y+i.h+g>n.point2.y?n.point2.y-i.h-i.y:g;var f=c.x-d.x;l=i.x+f<n.point1.x?n.point1.x-i.x:i.x+i.w+f>n.point2.x?n.point2.x-i.w-i.x:f,i.w>=this.focusArea.point2.x-this.focusArea.point1.x&&i.h>=this.focusArea.point2.y-this.focusArea.point1.y&&.8<=i.w/(n.point2.x-n.point1.x)&&.8<=i.h/(n.point2.y-n.point1.y)&&(i.autoCropWarning=!1)}i.x+l<0?i.x=0:i.x+l+i.w>this.w?i.x=this.w-i.w:i.x+=l,i.y+u<0?i.y=0:i.y+u+i.h>this.h?i.y=this.h-i.h:i.y+=u}}})}(IMSoftcrop),function(t){t.Softcrop=function(i,e,a,o,s,n){t.Shape.call(this,i,e),this.x=s.x,this.y=s.y,this.w=s.w,this.h=s.h,this.respectRatio=n,this.ratio={w:a,h:o,f:t.Ratio.decimal(a,o)},this.handles={nw:[0,0,0],n:[0,0,0],ne:[0,0,0],e:[0,0,0],se:[0,0,0],s:[0,0,0],sw:[0,0,0],w:[0,0,0]},this.ready=!0},t.Softcrop.prototype=Object.create(Shape.prototype,{lineWidth:{value:1},lineColor:{value:"rgba(255, 255, 255, 1)"},lineColorActive:{value:"rgba(0, 255, 255, 1)"},handleThickness:{value:3},handleLength:{value:14},handles:{writable:!0},handle:{writable:!0},ratio:{writable:!0},respectRatio:{value:!0,writable:!0},autoCropWarning:{value:!1,writable:!0},locked:{value:!1,writable:!0},dragHandle:{value:function(i,e){if("string"==typeof this.handle){var a=this.parent.getDimensions(),o=this.x,s=this.y,n=this.w,h=this.h;switch(i){case"n":s+=e.y,h-=e.y,n=t.Ratio.width(h,this.ratio.f),o+=t.Ratio.width(e.y/2,this.ratio.f);break;case"e":n+=e.x,h=t.Ratio.height(n,this.ratio.f),s-=t.Ratio.height(e.x/2,this.ratio.f);break;case"s":h+=e.y,n=t.Ratio.width(h,this.ratio.f),o-=t.Ratio.width(e.y/2,this.ratio.f);break;case"w":n-=e.x,o+=e.x,h=t.Ratio.height(n,this.ratio.f),s+=t.Ratio.height(e.x/2,this.ratio.f);break;case"nw":Math.abs(e.x)>Math.abs(e.y)?(n-=e.x,o+=e.x,h-=t.Ratio.height(e.x,this.ratio.f),s+=t.Ratio.height(e.x,this.ratio.f)):(h-=e.y,s+=e.y,n-=t.Ratio.width(e.y,this.ratio.f),o+=t.Ratio.width(e.y,this.ratio.f));break;case"ne":Math.abs(e.x)>Math.abs(e.y)?(n+=e.x,h+=t.Ratio.height(e.x,this.ratio.f),s-=t.Ratio.height(e.x,this.ratio.f)):(n-=t.Ratio.width(e.y,this.ratio.f),h-=e.y,s+=e.y);break;case"se":Math.abs(e.x)>Math.abs(e.y)?(n+=e.x,h+=t.Ratio.height(e.x,this.ratio.f)):(h+=e.y,n+=t.Ratio.width(e.y,this.ratio.f));break;case"sw":Math.abs(e.x)>Math.abs(e.y)?(n-=e.x,o+=e.x,h-=t.Ratio.height(e.x,this.ratio.f)):(n+=t.Ratio.width(e.y,this.ratio.f),o-=t.Ratio.width(e.y,this.ratio.f),h+=e.y)}40>h||40>n||n>a.w||h>a.h||o+n>a.w||s+h>a.h||(0>o&&(o=0),0>s&&(s=0),this.x=Math.round(o),this.y=Math.round(s),this.w=Math.round(n),this.h=Math.round(h))}}},move:{value:function(i){var e=this.parent.getDimensions();return this.x+i.x<0&&(this.x=0,i.x=0),this.y+i.y<0&&(i.y=0,this.y=0),this.w+this.x+Math.round(i.x)>e.w?void(i.x=e.w-this.w):this.h+this.y+Math.round(i.y)>e.h?void(i.y=e.h-this.h):void t.Shape.prototype.move.call(this,i)}},overHandle:{value:function(t){var i="",e=this.overVerticalArea(t),a=this.overHorizontalArea(t);return!a&&!e||a&&e?a==e?i="":(i=a+e,i=i.replace("m","")):i="",this.handle=""===i?!1:i,this.handle}},overHorizontalArea:{value:function(t){var i=this.drawX-this.handleThickness,e=this.drawX+this.drawW+this.handleThickness;return this.withinCoordinates(t,i,this.drawY+this.drawH-this.handleLength+this.handleThickness,e,this.drawY+this.drawH+this.handleThickness)?"s":this.withinCoordinates(t,i,this.drawY+this.drawH/2-this.handleLength,e,this.drawY+this.drawH/2+this.handleLength)?"m":this.withinCoordinates(t,i,this.drawY-this.handleThickness,e,this.drawY+this.handleLength)?"n":""}},overVerticalArea:{value:function(t){var i=this.drawY-this.handleThickness,e=this.drawY+this.drawH+this.handleThickness;return this.withinCoordinates(t,this.drawX+this.drawW-this.handleLength,i,this.drawX+this.drawW+this.handleThickness,e)?"e":this.withinCoordinates(t,this.drawX+this.drawW/2-this.handleLength,i,this.drawX+this.drawW/2+this.handleLength,e)?"m":this.withinCoordinates(t,this.drawX-this.handleThickness,i,this.drawX+this.handleLength,e)?"w":""}},redraw:{value:function(t){if(this.ready){this.getDimensionsInCanvas(this.parent.getCoordinates()),this.drawCropMargins();var i=2*this.handleLength;this.ctx.beginPath(),this.drawHandle("nw",!1,this.drawX,this.drawY,this.handleLength,this.handleThickness),this.drawHandle("se",!1,this.drawXW,this.drawYH,this.handleLength,this.handleThickness),this.drawHandle("ne",!1,this.drawXW,this.drawY,this.handleLength,this.handleThickness),this.drawHandle("sw",!1,this.drawX,this.drawYH,this.handleLength,this.handleThickness);var e=this.drawW/2,a=this.drawH/2;this.drawHandle("n",!1,this.drawX+e,this.drawY,i,this.handleThickness),this.drawHandle("e",!1,this.drawXW,this.drawY+a,i,this.handleThickness),this.drawHandle("s",!1,this.drawX+e,this.drawYH,i,this.handleThickness),this.drawHandle("w",!1,this.drawX,this.drawY+a,i,this.handleThickness),this.ctx.stroke(),this.ctx.closePath(),this.drawCropBorder(),"object"==typeof t&&t.guides===!0&&this.drawCropGuidelines()}}},drawCropGuidelines:{value:function(){this.ctx.closePath(),this.ctx.beginPath(),this.ctx.setLineDash&&this.ctx.setLineDash([3,3]),this.ctx.strokeStyle="rgba(55, 55, 55, 0.5)",this.ctx.lineWidth=1;var t=this.drawH/3,i=this.drawW/3;this.ctx.moveTo(this.drawX,this.drawY+t),this.ctx.lineTo(this.drawX+this.drawW,this.drawY+t),this.ctx.moveTo(this.drawX,this.drawY+t+t),this.ctx.lineTo(this.drawX+this.drawW,this.drawY+t+t),this.ctx.moveTo(this.drawX+i,this.drawY),this.ctx.lineTo(this.drawX+i,this.drawY+this.drawH),this.ctx.moveTo(this.drawX+i+i,this.drawY),this.ctx.lineTo(this.drawX+i+i,this.drawY+this.drawH),this.ctx.stroke(),this.ctx.setLineDash&&this.ctx.setLineDash([]),this.ctx.closePath()}},drawCropBorder:{value:function(){this.ctx.beginPath(),this.ctx.strokeStyle="rgba(0, 0, 0, 0.2)",this.ctx.lineWidth=1,this.ctx.rect(this.drawX-.5,this.drawY-.5,this.drawW+1,this.drawH+1),this.ctx.stroke(),this.ctx.closePath()}},drawCropMargins:{value:function(){this.ctx.beginPath(),this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.rect(0,0,this.canvas.width,this.drawY),this.ctx.rect(0,0,this.drawX,this.canvas.height),this.ctx.rect(this.drawX,this.drawYH,this.canvas.width,this.canvas.height),this.ctx.rect(this.drawXW,this.drawY,this.canvas.width,this.drawH),this.ctx.fill(),this.ctx.closePath()}},drawHandle:{value:function(t,i,e,a,o,s){var n=s/2,h=o/2;switch(this.ctx.lineWidth=s,this.ctx.strokeStyle=i?this.lineColorActive:this.lineColor,t){case"se":n=-1*n,o=-1*o;case"nw":this.ctx.moveTo(e-n,a+o),this.ctx.lineTo(e-n,a-n),this.ctx.lineTo(e+o,a-n),this.handles[t]=[e,a,s,o];break;case"sw":n=-1*n,o=-1*o;case"ne":this.ctx.moveTo(e-o,a-n),this.ctx.lineTo(e+n,a-n),this.ctx.lineTo(e+n,a+o),this.handles[t]=[e,a,s,o];break;case"n":this.ctx.moveTo(e-h,a-n),this.ctx.lineTo(e+h,a-n);break;case"s":this.ctx.moveTo(e-h,a+n),this.ctx.lineTo(e+h,a+n);break;case"w":this.ctx.moveTo(e-n,a+h),this.ctx.lineTo(e-n,a-h);break;case"e":this.ctx.moveTo(e+n,a+h),this.ctx.lineTo(e+n,a-h)}}}}),t.Softcrop.prototype.constructor=t.Softcrop}(IMSoftcrop);