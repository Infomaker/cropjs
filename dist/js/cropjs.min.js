/**
 * @infomaker/cropjs - Image soft cropper for predefined crop definitions featuring automatic crop suggestions. Created by Infomaker Scandinavia AB
 * @author Danne Lundqvist <danne.lundqvist@infomaker.se>
 * @version v2.0.0
 * @link http://www.infomaker.se
 * @license MIT
 */
!function(){this.IMCropUI=function(){},IMCropUI.Toggle=function(t,i){var e,a=t,s=!1,o=i,n=this;if(e=document.getElementById(a)){e.classList.contains("on")&&(s=!0);var r=e.getElementsByTagName("em");1==r.length&&r[0].classList.contains("hint")&&(e.title=r[0].innerHTML),Object.defineProperty(this,"on",{get:function(){return s},set:function(t){(s=t)&&!e.classList.contains("on")?e.classList.add("on"):!t&&e.classList.contains("on")&&e.classList.remove("on")}}),e.addEventListener("click",function(t){return this.classList.toggle("on"),t.preventDefault(),t.stopPropagation(),s=this.classList.contains("on"),"function"==typeof o&&o.call(n,t),!1})}else console.log("Element not found: "+a)},IMCropUI.Button=function(t,i){var e,a=t,s=i,o=this;(e=document.getElementById(a))?e.addEventListener("click",function(t){return t.preventDefault(),t.stopPropagation(),"function"==typeof s&&s.call(o,t),!1}):console.log("Element not found: "+a)}}();var IMSoftcrop=function(){var l={},a={};return l.Editor=function(t,i){if(this._id=t,this._crops=[],a={onKeyDown:this.onKeyDown.bind(this),onResize:this.onResize.bind(this),onDoubleClick:this.onDoubleClick.bind(this),onMouseMove:this.onMouseMove.bind(this),onMouseUp:this.onMouseUp.bind(this),onMouseDown:this.onMouseDown.bind(this),onMouseWheel:this.onMouseWheel.bind(this)},"object"==typeof i&&!0===i.debug&&(this._debug=!0),this.setupUI(),this.adjustForPixelRatio(),this.calculateViewport(),this.addCanvasEventListeners(),this.setupAnimation(),this.runAnimation(),"object"==typeof i){var e=this;!0===i.debug&&this._debug&&(this._debugContainer=i.debugElement),!0===i.autocrop&&(this._autocrop=!0),"string"==typeof i.detectWorkerUrl&&(this._detectWorkerUrl=i.detectWorkerUrl),"number"==typeof i.detectThreshold&&(this._detectThreshold=i.detectThreshold),"number"==typeof i.detectStepSize&&(this._detectStepSize=i.detectStepSize)}this._cropLockedToggle=new IMCropUI.Toggle("imc_croplocked",function(){e._crop instanceof l.Softcrop&&(e._crop.locked=this.on,e._renderUpdatedPreview(e._crop))}),this._cropUsableToggle=new IMCropUI.Toggle("imc_cropusable",function(){e._crop instanceof l.Softcrop&&(e._crop.usable=this.on,e._renderUpdatedPreview(e._crop))}),this._guidesToggle=new IMCropUI.Toggle("imc_guides",function(){e.redraw()}),this._focusPointsToggle=new IMCropUI.Toggle("imc_focuspoints",function(){e.redraw()})},l.Editor.prototype={_id:"",_container:void 0,_canvas:void 0,_ctx:void 0,_redrawCanvas:!1,_previewContainer:void 0,_debugContainer:void 0,_image:void 0,_crops:void 0,_crop:void 0,handle:void 0,info:"image",_dragObject:void 0,_dragPoint:void 0,_position:{x:0,y:0},_zoomLevel:1,_keepCenter:!1,_scale:1,_margin:5,_waitForWorkers:0,_zoomMax:5,_zoomMin:.1,_autocrop:!1,_applyAutocrop:!0,_detectWorkerUrl:void 0,_detectThreshold:60,_detectStepSize:1.6,_debug:!1,_onSave:void 0,_onCancel:void 0,_guidesToggle:void 0,_focusPointsToggle:void 0,_cropLockedToggle:void 0,_cropUsableToggle:void 0,setupUI:function(){if(this.injectHTML(),this._container=document.getElementById("imc_container"),!this._container)throw new Error("Container element with id <imc_container> not found");if(this._previewContainer=document.getElementById("imc_preview_container"),!this._previewContainer)throw new Error("Preview element with id <imc_preview_container> not found");if(this._canvas=document.getElementById("imc_canvas"),!this._canvas)throw new Error("Canvas element with id <imc_canvas_initial> not found");this._ctx=this._canvas.getContext("2d")},injectHTML:function(){var t=document.getElementById(this._id);if(!t)throw new Error("Could not find element with id <"+this._id+"> to inject crop editor into");var i=this._debug?"imc_debug":"";t.innerHTML='<div id="imc" class="'+i+'"><div id="imc_container"><canvas id="imc_canvas"></canvas><div id="imc_work_container"><div id="imc_preview_container" class="imc_preview_container"></div></div><div id="imc_image_inline"><div class="imc_debug_group"><a href="#" id="imc_focuspoints" class="toggle"><em class="hint">Detaljer</em><span><span class="on"><i class="fa fa-object-group"></i></span><span class="off"><i class="fa fa-object-group"></i></span></span></a><a href="#" id="imc_guides" class="toggle on"><em class="hint">Guide lines</em><span><span class="on"><i class="fa fa-th"></i></span><span class="off"><i class="fa fa-th"></i></span></span></a><a href="#" id="imc_croplocked" class="toggle"><em class="hint">Låst till användare</em><span><span class="on"><i class="fa fa-lock"></i></span><span class="off"><i class="fa fa-unlock"></i></span></span></a><a href="#" id="imc_cropusable" class="toggle"><em class="hint">Använd denna crop</em><span><span class="on"><i class="fa fa-check"></i></span><span class="off"><i class="fa fa-ban"></i></span></span></a></div><div id="imc_image_info" class="display"></div><div id="imc_loading"><i class="fa fa-cog fa-spin"></i></div></div></div></div>'},setupAnimation:function(){for(var o=0,t=["webkit","moz"],i=0;i<t.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[t[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[i]+"CancelAnimationFrame"]||window[t[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,i){var e=(new Date).getTime(),a=Math.max(0,16-(e-o)),s=window.setTimeout(function(){t(e+a)},a);return o=e+a,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})},runAnimation:function(){var t=this;if(requestAnimationFrame(function(){t.runAnimation()}),this._redrawCanvas){if(this.calculateViewport(),this._redrawCanvas=!1,this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._image instanceof l.Image){this._image.redraw({guides:this._guidesToggle.on,focuspoints:this._focusPointsToggle.on});for(var i=this._image.getSoftCrops(),e=0;e<i.length;e++)i[e]instanceof l.Softcrop&&this._renderUpdatedPreview(i[e])}this._debug&&this._renderDebug()}},redraw:function(){this._redrawCanvas=!0},toggleLoadingImage:function(t){var i=document.getElementById("imc_loading");return void 0===t?i.classList.contains("loading"):(t?i.classList.add("loading"):i.classList.remove("loading"),t)},_renderNewCropPreview:function(t,i){var e=this,a=document.createElement("div");a.id=this._image.id+"_"+t.id,a.classList.add("imc_preview_image_container"),i&&a.classList.add("active"),a.addEventListener("click",function(){e.setActiveCrop(t)});var s=document.createElement("div");s.classList.add("imc_preview_image");l.Ratio.width(90,t.ratio.f);s.style.width=l.Ratio.width(90,t.ratio.f)+"px";var o=document.createElement("span");o.classList.add("crop-ratio-wrapper");var n=document.createElement("span");n.classList.add("crop-ratio-text");var r=document.createElement("i");r.className="fa fa-warning";var h=document.createElement("span"),c=t;h.className="fa fa-check",h.classList.add("crop-ratio-icon"),h.addEventListener("click",function(t){return e.toggleCropUsable(c),t.preventDefault(),t.stopPropagation(),!1}),n.appendChild(document.createTextNode(t.id)),o.appendChild(n),o.appendChild(h),o.appendChild(r);var d=new Image;d.onload=function(){s.classList.add("loaded")},d.src=this._image.src,s.appendChild(d),s.appendChild(o),a.appendChild(s),this._previewContainer.appendChild(a),this._renderUpdatedPreview(t)},_renderUpdatedPreview:function(t){var i=document.getElementById(this._image.id+"_"+t.id);if(null!=i&&"object"==typeof i){var e=i.getElementsByTagName("DIV")[0],a=i.getElementsByTagName("IMG")[0],s=window.getComputedStyle(e).height.slice(0,-2),o=this._image.getDimensions(),n=l.Ratio.width(s,t.ratio.f);e.style.width=n+"px";var r=t.getDimensions(),h=n/r.w;a.style.height=o.h*h+"px",a.style.marginTop="-"+r.y*h+"px",a.style.marginLeft="-"+r.x*h+"px",1==t.autoCropWarning?i.classList.add("warning"):i.classList.remove("warning"),1==t.usable?(i.classList.add("usable"),i.classList.remove("unusable")):(i.classList.add("unusable"),i.classList.remove("usable"))}},getDimensions:function(){return{margin:this._margin,width:this._canvas.width,height:this._canvas.height}},updateImageInfo:function(t){var i,e,a,s=t?"crop":"image",o=document.getElementById("imc_image_info");if(o){if(t){if(this._crop instanceof l.Softcrop==0)return;i=this._crop.getDimensions()}else{if(this._image instanceof l.Image==0)return;i=this._image.getDimensions()}e=Math.round(i.w),a=Math.round(i.h),this.info!=s?(this.info=s,o.className="",setTimeout(function(){o.innerHTML=e+"x"+a,o.className="display "+s},200)):o.innerHTML=e+"x"+a}},adjustForPixelRatio:function(t){var i=t||this._canvas,e=i.getContext("2d"),a=window.devicePixelRatio||1,s=e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1,o=a/s;if(a!==s){var n=this._container.clientWidth,r=this._container.clientHeight;i.width=n*o,i.height=r*o,i.style.width=n+"px",i.style.height=r+"px",e.scale(o,o),this._scale=o}else i.width=this._container.clientWidth,i.height=this._container.clientHeight},addImage:function(t,i,e){var a=this;this.toggleLoadingImage(!0),this.clear(),this._applyAutocrop=!1!==e,this._image=new l.Image(l.Ratio.hashFnv32a(t),this),this._image.load(t,function(){a.setZoomToImage(!1),a.centerImage(!1),a.updateImageInfo(!1),a._autocrop?(a.detectDetails(),a.detectFaces()):a.toggleLoadingImage(!1),a.applySoftcrops(),a.redraw(),"function"==typeof i&&i.call(a,a._image)})},addSoftcrop:function(t,i,e,a,s,o,n){var r=!1;e=parseFloat(e),a=parseFloat(a),void 0===s||void 0===o||null===s||null===o?o=s=null:(s=parseInt(s),o=parseInt(o),r=!0),n=void 0===n||n,this._crops.push({id:t,setAsCurrent:0==this._crops.length||i,hRatio:e,vRatio:a,x:s,y:o,exact:r,usable:!!n}),this._image instanceof l.Image&&this._image.ready&&this.applySoftcrops()},getSoftcropData:function(){for(var t={src:this._image.src,width:this._image.w,height:this._image.h,crops:[]},i=0;i<this._image.crops.length;i++)t.crops.push({id:this._image.crops[i].id,x:Math.round(this._image.crops[i].x),y:Math.round(this._image.crops[i].y),width:Math.round(this._image.crops[i].w),height:Math.round(this._image.crops[i].h),usable:this._image.crops[i].usable});return t},applySoftcrops:function(){if(this._image instanceof l.Image!=0&&this._image.ready)for(var t=0;t<this._crops.length;t++){if(null==(i=this._image.getSoftcrop(this._crops[t].id))){var i=this._image.addSoftcrop(this._crops[t].id,this._crops[t].setAsCurrent,this._crops[t].hRatio,this._crops[t].vRatio,this._crops[t].x,this._crops[t].y,this._crops[t].exact,this._crops[t].usable);this._autocrop&&this._image.autocrop(),this._renderNewCropPreview(i,this._crops[t].setAsCurrent)}this._crops[t].setAsCurrent&&this.setActiveCrop(i)}},setActiveCrop:function(t){if(t instanceof l.Softcrop==!0){for(var i=document.getElementById(this._image.id+"_"+t.id),e=this._previewContainer.getElementsByClassName("imc_preview_image_container"),a=0;a<e.length;a++)e[a].classList.remove("active");i.classList.add("active"),this._crop=t,this._image.setActiveCrop(t),this._cropLockedToggle.on=t.locked,this._cropUsableToggle.on=t.usable,this.redraw(),this.updateImageInfo(!0)}},toggleCropUsable:function(t){void 0===t&&(t=this._crop),t.usable=!t.usable,this._renderUpdatedPreview(t),t.id===this._crop.id&&(this._cropUsableToggle.on=t.usable)},clear:function(){this._image instanceof l.Image!=0&&(this._image.clear(),this._crops=[],this._crop=void 0,this._image=void 0,this._previewContainer.innerHTML="",this.redraw())},autocropImages:function(){this._autocrop&&this._applyAutocrop&&(this.toggleLoadingImage()||this.toggleLoadingImage(!0),this._image.autocrop()&&this.redraw()),0==this._waitForWorkers&&this.toggleLoadingImage(!1)},getImageData:function(){if(!(!this._image instanceof l.Image)&&this._image.ready){var t=document.getElementsByTagName("body"),i=document.createElement("canvas"),e=i.getContext("2d");i.style.display="none",t[0].appendChild(i),i.width=this._image.w,i.height=this._image.h,i.style.width=this._image.w+"px",i.style.height=this._image.h+"px",e.drawImage(this._image.image,0,0,this._image.w,this._image.h);var a=e.getImageData(0,0,this._image.w,this._image.h);return e=null,t[0].removeChild(i),i=null,t[0]=null,t=null,a}},detectDetails:function(){if(!(!this._image instanceof l.Image)&&this._image.ready){var i=this,t=this.getImageData();if(this._waitForWorkers++,window.Worker){var e=new Worker(this._detectWorkerUrl);e.postMessage(["details",t,this._image.w,this._image.h,this._detectThreshold]),e.onmessage=function(t){i.addDetectedDetails(t.data),i._waitForWorkers--,i.autocropImages()}}else{var a=tracking.Fast.findCorners(tracking.Image.grayscale(t.data,this._image.w,this._image.h),this._image.w,this._image.h,this._detectThreshold);this.addDetectedDetails(a),this._waitForWorkers--,this.autocropImages()}}},addDetectedDetails:function(t){for(var i=[],e=0;e<t.length;e+=2)i.push({x:t[e],y:t[e+1]});this._image.addDetailData(i)},detectFaces:function(){if(!(!this._image instanceof l.Image)&&this._image.ready){this._waitForWorkers++;var e=this;if(window.Worker){var t=new Worker(this._detectWorkerUrl);t.postMessage(["features",this.getImageData(),this._image.w,this._image.h,this._detectStepSize]),t.onmessage=function(t){for(var i=0;i<t.data.length;i++)e.addDetectedFeature(t.data[i]);e._waitForWorkers--,e.autocropImages()}}else{tracking.trackData=function(t,i,e,a){var s=new tracking.TrackerTask(t);return s.on("run",function(){t.track(i.data,e,a)}),s.run()};var i=new tracking.ObjectTracker(["face"]);i.setStepSize(this._detectStepSize),i.on("track",function(t){t.data.forEach(function(t){e.addDetectedFeature(t)}),e._waitForWorkers--,e.autocropImages()}),tracking.trackData(i,this.getImageData(),this._image.w,this._image.h)}}},addDetectedFeature:function(t){var i=0,e={x:t.x,y:t.y};i=(.45<t.width/this._image.w?(t.height*=1.2,e.x+=t.width/2,e.y+=t.height/2):(t.height*=1.4,e.x+=t.width/2,e.y+=t.height/4),t.height>t.width?t.height/2:t.width/2),this._image.addFocusPoint(e,i)},canvasLineInImage:function(t){return t/this._zoomLevel},imageLineInCanvas:function(t){return t*this._zoomLevel},imagePointInCanvas:function(t,i){return{x:Math.round((t+this._image.x)*this._zoomLevel)+this._margin,y:Math.round((i+this._image.y)*this._zoomLevel)+this._margin}},canvasPointInImage:function(t,i){return{x:Math.round((t-this._margin)/this._zoomLevel)-this._image.x,y:Math.round((i-this._margin)/this._zoomLevel)-this._image.y}},centerImage:function(t){var i,e;this._keepCenter=!0,i=this._container.clientWidth/2,e=this._container.clientHeight/2;var a=this._image.w*this._zoomLevel/2+this._image.x*this._zoomLevel+this._margin,s=this._image.h*this._zoomLevel/2+this._image.y*this._zoomLevel+this._margin,o=i==a?0:(i-a)/this._zoomLevel,n=e==s?0:(e-s)/this._zoomLevel;this._image.move({x:o,y:n}),!0===t&&this.redraw()},getZoom:function(t){return!0===t?this._zoomLevel:100*this._zoomLevel},setZoom:function(t,i){this._zoomLevel=t/100,this._keepCenter&&this.centerImage(!1),!0===i&&this.redraw()},setZoomToImage:function(t){var i=this._image.getDimensions(),e=(this._container.clientHeight-2*this._margin)/i.h,a=(this._container.clientWidth-2*this._margin)/i.w;if(e<a&&e<1&&this._zoomLevel>e)this._zoomLevel=e,this.centerImage(!1);else{if(!(a<1&&this._zoomLevel>a))return;this._zoomLevel=a,this.centerImage(!1)}!0===t&&this.redraw()},removeEventListeners:function(){window.removeEventListener("resize",a.onResize),window.removeEventListener("mouseup",a.onMouseUp),this._canvas.removeEventListener("dblclick",a.onDoubleClick),this._canvas.removeEventListener("mousedown",a.onMouseDown),this._canvas.removeEventListener("mouseup",a.onMouseUp),this._canvas.removeEventListener("mousemove",a.onMouseMove),this._canvas.removeEventListener("mousewheel",a.onMouseWheel,!1),document.removeEventListener("keydown",a.onKeyDown,!1)},addCanvasEventListeners:function(){window.addEventListener("resize",a.onResize,!1),window.addEventListener("mouseup",a.onMouseUp),this._canvas.addEventListener("dblclick",a.dblclick),this._canvas.addEventListener("mousedown",a.onMouseDown),this._canvas.addEventListener("mouseup",a.onMouseUp),this._canvas.addEventListener("mousemove",a.onMouseMove),this._canvas.addEventListener("mousewheel",a.onMouseWheel,!1),document.addEventListener("keydown",a.onKeyDown,!1)},onSave:function(t){"function"==typeof t&&(this._onSave=t)},onCancel:function(t){"function"==typeof t&&(this._onCancel=t)},onResize:function(){this._keepCenter&&this.centerImage(!1),this.redraw()},onDoubleClick:function(t){if(t.preventDefault(),t.stopPropagation(),void 0===this._image)return!1;this.toggleLoadingImage(!0);var i=this.getMousePoint(t);return this._image.addFocusPoint(this.canvasPointInImage(i.x,i.y),40),this._image.autocrop()&&(this.redraw(),this.toggleLoadingImage(!1)),!1},onMouseDown:function(t){var i=this.getMousePoint(t);this._crop instanceof l.Softcrop&&"string"==typeof this.handle?(this.updateImageInfo(!0),this._dragPoint=i,this._dragObject=this.handle):this._crop instanceof l.Softcrop&&this._crop.inArea(i)?(this.updateImageInfo(!0),this._dragObject=this._crop,this._dragPoint=i):this._image instanceof l.Image&&this._image.inArea(i)&&(this.updateImageInfo(!1),this._dragObject=this._image,this._dragPoint=i)},onMouseUp:function(){this._dragObject=void 0,this._dragPoint=void 0},onMouseMove:function(t){var i=this.getMousePoint(t);if(void 0!==this._dragObject)return"string"==typeof this._dragObject?(this._image.detectionReady()||(this._crop.locked=!0),this._crop.dragHandle(this._dragObject,{x:(i.x-this._dragPoint.x)/this._zoomLevel,y:(i.y-this._dragPoint.y)/this._zoomLevel}),this.updateImageInfo(!0)):(this._dragObject instanceof l.Image&&(this._keepCenter=!1),this._dragObject.move({x:(i.x-this._dragPoint.x)/this._zoomLevel,y:(i.y-this._dragPoint.y)/this._zoomLevel})),this.updateImageInfo(!0),this.redraw(),void(this._dragPoint=i);if(this._crop instanceof l.Softcrop){var e=this._crop.overHandle(i);if(!1!==e&&this.handle!=e)return this._canvas.style.cursor="nw"==e||"se"==e?"nwse-resize":"ne"==e||"sw"==e?"nesw-resize":"n"==e||"s"==e?"ns-resize":"ew-resize",void(this.handle=e);if(!1===e&&this.handle)return this._canvas.style.cursor="default",void(this.handle=void 0);if(this.handle)return}this._image instanceof l.Image&&this._image.inArea(i)?this._canvas.style.cursor="move":this._canvas.style.cursor="default"},onMouseWheel:function(t){t.preventDefault(),t.stopPropagation();var i=Math.max(-1,Math.min(1,t.wheelDelta||-t.detail)),e=0;if(i<0&&this._zoomLevel<this._zoomMax)e=this._zoomLevel<1?.01:.03;else{if(!(0<i&&this._zoomLevel>this._zoomMin))return;e=this._zoomLevel<1?-.01:-.03}var a=(this._image.w/2+this._image.x)*e,s=(this._image.h/2+this._image.y)*e;this._zoomLevel+=e,this._image.move({x:-a/this._zoomLevel,y:-s/this._zoomLevel}),this.redraw()},getMousePoint:function(t){return{x:t.pageX-this._position.x,y:t.pageY-this._position.y}},getCanvas:function(){return this._canvas},calculateViewport:function(){var t=l.Ratio.getElementPosition(this._canvas);this._position.x=t.x,this._position.y=t.y},onKeyDown:function(t){var i=t.keyCode||t.which,e=this;if(13===i)return e._onSave(e.getSoftcropData()),t.preventDefault(),t.stopPropagation(),!1;if(27===i)return e._onCancel(),t.preventDefault(),t.stopPropagation(),!1;if(9===i){for(var a,s=e._image.getSoftCrops(),o=0;o<s.length;o++)if(e._crop===s[o]){a=o;break}return void 0!==a&&((o+=t.shiftKey?-1:1)<0?o=s.length-1:o+1>s.length&&(o=0),e.setActiveCrop(s[o])),t.preventDefault(),t.stopPropagation(),!1}},_renderDebug:function(){if(this._drawCross("red",{x:this._container.clientWidth/2,y:this._container.clientHeight/2}),this._drawCross("green",{x:this._image.w*this._zoomLevel/2+this._image.x*this._zoomLevel+this._margin,y:this._image.h*this._zoomLevel/2+this._image.y*this._zoomLevel+this._margin}),void 0!==this._debugContainer){var t="<pre>";t+="Zoom level: "+this._zoomLevel+"\n",void 0!==this._image&&(t+="Image w: "+this._image.w+"\n",t+="      h: "+this._image.h+"\n",t+="\n",void 0!==this._image.crop&&(t+="Crop  x: "+this._image.crop.x+"\n",t+="      y: "+this._image.crop.y+"\n",t+="      w: "+this._image.crop.w+"\n",t+="      h: "+this._image.crop.h+"\n")),t+="</pre>",this._debugContainer.innerHTML=t}},_drawCross:function(t,i){var e=this._canvas.getContext("2d");e.beginPath(),e.fillStyle=t,e.strokeStyle=t,e.lineWidth=.5,e.arc(i.x,i.y,5,0,2*Math.PI,!1),e.fill(),e.beginPath(),e.moveTo(i.x-50,i.y),e.lineTo(i.x+50,i.y),e.stroke(),e.beginPath(),e.moveTo(i.x,i.y-50),e.lineTo(i.x,i.y+50),e.stroke()}},l}();!function(h){h.Ratio=function(){},h.Ratio.decimal=function(t,i){return i/t},h.Ratio.height=function(t,i){return Math.round(t*i)},h.Ratio.width=function(t,i){return Math.round(t/i)},h.Ratio.fitInto=function(t,i){var e=h.Ratio.decimal(i.w,i.h),a=h.Ratio.decimal(t.w,t.h),s=0,o=0,n=t.w,r=t.h;return e<a?(r=h.Ratio.height(n,e),o=(t.h-r)/2):(n=h.Ratio.width(r,e),s=(t.w-n)/2),{x:s,y:o,w:n,h:r}},h.Ratio.fitAround=function(t,i){var e=0,a=0;return 1==h.Ratio.decimal(t.w,t.h)?a=e=i.w>i.h?i.w:i.h:t.w/i.w>t.h/i.h?(a=i.h,e=i.h*(t.w/t.h)):(e=i.w,a=i.w*(t.h/t.w)),{w:e,h:a}},h.Ratio.getElementPosition=function(t){for(var i=0,e=0;t;)i+=t.offsetLeft-t.scrollLeft+t.clientLeft,e+=t.offsetTop-t.scrollTop+t.clientTop,t=t.offsetParent;return{x:i,y:e}},h.Ratio.hashFnv32a=function(t,i){var e,a,s=void 0===i?2166136261:i;for(e=0,a=t.length;e<a;e++)s^=t.charCodeAt(e),s+=(s<<1)+(s<<4)+(s<<7)+(s<<8)+(s<<24);return("0000000"+(s>>>0).toString(16)).substr(-8)},h.Ratio.areaCoverage=function(t,i,e,a){return Math.round(t*i*100/(e*a))}}(IMSoftcrop),function(s){s.Base=function(){},s.Base.prototype={},s.Shape=function(t,i){if(void 0!==i){this.id=t;var e=this.parent=i;do{if(e instanceof s.Editor){this.editor=e;break}e=e.parent}while(void 0!==e);var a=this.editor.getCanvas();if(!a||"CANVAS"!=a.tagName)throw new TypeError("Canvas required");this.canvas=a,this.ctx=a.getContext("2d")}},s.Shape.prototype=Object.create(s.Base.prototype,{id:{writable:!0},editor:{writable:!0},parent:{writable:!0},canvas:{writable:!0},ctx:{writable:!0},_ready:{value:!1,writable:!0},ready:{get:function(){return this._ready},set:function(t){this._ready=!0===t}},x:{value:0,writable:!0},y:{value:0,writable:!0},w:{value:0,writable:!0},h:{value:0,writable:!0},drawX:{value:0,writable:!0},drawY:{value:0,writable:!0},drawW:{value:0,writable:!0},drawH:{value:0,writable:!0},drawXW:{value:0,writable:!0},drawYH:{value:0,writable:!0},getCanvas:{value:function(){return this.canvas}},inArea:{value:function(t){return!!this.ready&&this.inCalculatedArea(t,this.drawX,this.drawY,this.drawW,this.drawH)}},withinCoordinates:{value:function(t,i,e,a,s){return!(t.x<i||t.x>a)&&!(t.y<e||t.y>s)}},inCalculatedArea:{value:function(t,i,e,a,s){return t.x>=i&&t.x<=i+a&&t.y>=e&&t.y<=e+s}},move:{value:function(t){this.x+=Math.round(t.x),this.y+=Math.round(t.y)}},getCoordinates:{value:function(){return{x:this.x,y:this.y}}},getDimensions:{value:function(){return{x:this.x,y:this.y,w:this.w,h:this.h}}},getDimensionsInCanvas:{value:function(t){void 0===t&&(t={x:0,y:0});var i=this.editor.getDimensions(),e=this.editor.getZoom(!0);this.drawW=Math.round(this.w*e),this.drawH=Math.round(this.h*e),this.drawX=Math.round((this.x+t.x)*e)+i.margin,this.drawY=Math.round((this.y+t.y)*e)+i.margin,this.drawXW=this.drawX+this.drawW,this.drawYH=this.drawY+this.drawH}}}),s.Shape.prototype.constructor=s.Shape}(IMSoftcrop),function(y){y.Image=function(t,i){y.Shape.call(this,t,i),this.crops=[],this.focusPoints=[]},y.Image.prototype=Object.create(y.Shape.prototype,{src:{value:"string",writable:!0},image:{writable:!0},crops:{writable:!0},focusPoints:{writable:!0},focusArea:{writable:!0},detailData:{writable:!0},detailArea:{writable:!0},load:{value:function(t,i){var e=document.createElement("img"),a=this;e.crossOrigin="*",e.addEventListener("load",function(){a.w=this.naturalWidth,a.h=this.naturalHeight,a.image=this,a.ready=!0,i()},!1),e.src=t,this.src=t}},clear:{value:function(){for(var t=0;t<this.crops.length;t++)this.crops[t]=null;this.crops=[],this.crop=null,this.image=null}},addSoftcrop:{value:function(t,i,e,a,s,o,n,r){var h,c;return null!=(h=this.getSoftcrop(t))||(c=null===s||null===o?y.Ratio.fitInto({w:this.w,h:this.h},{w:e,h:a}):{x:s,y:o,w:e,h:a},h=new y.Softcrop(t,this,e,a,c,!0,n,r),this.crops.push(h),i&&(this.crop=h)),h}},getSoftcrop:{value:function(t){for(var i=0;i<this.crops.length;i++)if(this.crops[i].id==t)return this.crops[i];return null}},detectionReady:{value:function(){return void 0!==this.detailArea}},getSoftCrops:{value:function(){return this.crops}},setActiveCrop:{value:function(t){this.crop=t}},getSrc:{value:function(){return this.src}},addDetailData:{value:function(t){for(var i={point1:{x:(this.detailData=t)[0].x,y:t[0].y},point2:{x:t[0].x,y:t[0].y}},e=1;e<t.length;e++)t[e].x<i.point1.x?i.point1.x=t[e].x:t[e].x>i.point2.x&&(i.point2.x=t[e].x),t[e].y<i.point1.y?i.point1.y=t[e].y:t[e].y>i.point2.y&&(i.point2.y=t[e].y);this.detailArea=i,this.constrainArea(this.detailArea)}},addFocusPoint:{value:function(t,i){t.r=i,this.focusPoints.push(t),void 0!==this.focusArea?(t.x-t.r<this.focusArea.point1.x&&(this.focusArea.point1.x=t.x-t.r),t.x+t.r>this.focusArea.point2.x&&(this.focusArea.point2.x=t.x+t.r),t.y-t.r<this.focusArea.point1.y&&(this.focusArea.point1.y=t.y-t.r),t.y+t.r>this.focusArea.point2.y&&(this.focusArea.point2.y=t.y+t.r),this.constrainArea(this.focusArea)):this.focusArea={point1:{x:t.x-i,y:t.y-i},point2:{x:t.x+i,y:t.y+i}}}},constrainArea:{value:function(t){t.point1.x<0&&(t.point1.x=0),t.point2.x>this.w&&(t.point2.x=this.w),t.point1.y<0&&(t.point1.y=0),t.point2.y>this.h&&(t.point2.y=this.h)}},redraw:{value:function(t){this.ready&&(this.getDimensionsInCanvas({x:0,y:0}),this.ctx.drawImage(this.image,this.drawX,this.drawY,this.drawW,this.drawH),"object"==typeof t&&!0===t.focuspoints&&this.drawFocusPoints(),this.crop instanceof y.Softcrop&&this.crop.redraw(t))}},drawFocusPoints:{value:function(){if(void 0!==this.detailArea){this.drawArea(this.detailArea,"rgba(255, 121, 255, 0.4)"),this.ctx.fillStyle="rgba(255, 121, 255, 0.5)";for(var t=0;t<this.detailData.length;t++){var i=this.editor.imagePointInCanvas(this.detailData[t].x,this.detailData[t].y);this.ctx.fillRect(i.x,i.y-3,6,6)}}if(void 0!==this.focusArea){this.drawArea(this.focusArea,"rgba(121, 121, 255, 0.4)");for(var e=0;e<this.focusPoints.length;e++){var a=this.editor.imagePointInCanvas(this.focusPoints[e].x,this.focusPoints[e].y),s=this.editor.imageLineInCanvas(this.focusPoints[e].r);this.ctx.beginPath(),this.ctx.fillStyle="rgba(255, 255, 255, 0.5)",this.ctx.lineWidth=1,this.ctx.arc(a.x,a.y,s,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.closePath()}}}},drawArea:{value:function(t,i){var e=this.editor.imagePointInCanvas(t.point1.x,t.point1.y),a=this.editor.imagePointInCanvas(t.point2.x,t.point2.y);this.ctx.strokeStyle=i,this.ctx.lineWidth=4,this.ctx.strokeRect(e.x+2,e.y+2,a.x-e.x-4,a.y-e.y-4)}},autocrop:{value:function(t){if(!this.detectionReady())return!1;for(var i=void 0!==t?new Array(t):this.crops,e=0;e<i.length;e++)i[e].locked||this.autoCropCrop(i[e]);return!0}},autoCropCrop:{value:function(t){var i=this.detailArea,e=void 0!==this.focusArea?this.focusArea:this.detailArea,a=i.point1.x<e.point1.x?i.point1.x:e.point1.x,s=i.point2.x>e.point2.x?i.point2.x:e.point2.x,o=i.point1.y<e.point1.x?i.point1.y:e.point1.y,n=i.point2.y>e.point2.y?i.point2.y:e.point2.y,r={x:0<a?a:0,y:0<o?o:0},h={x:s<this.w?s:this.w,y:n<this.h?n:this.h},c=y.Ratio.fitAround({w:t.ratio.w,h:t.ratio.h},{w:h.x-r.x,h:h.y-r.y});c.w<=this.w&&c.h<=this.h?(t.w=c.w,t.h=c.h):(c.w>this.w?(t.w=this.w,t.h=y.Ratio.height(this.w,t.ratio.f)):c.h>this.h?(t.h=this.h,t.w=y.Ratio.width(this.h,t.ratio.f)):console.log("Too wide and too high, how?!? Ignoring!"),t.autoCropWarning=!0);var d=r.x+(h.x-r.x)/2,l=r.y+(h.y-r.y)/2,u=e.point1.x+(e.point2.x-e.point1.x)/2,g=e.point1.y+(e.point2.y-e.point1.y)/2,p=t.x+t.w/2,m=t.y+t.h/2,w=d-p,v=l-m;if(t.autoCropWarning){var f=g-m;v=t.y+f<r.y?r.y-t.y:t.y+t.h+f>h.y?h.y-t.h-t.y:f;var _=u-p;w=t.x+_<r.x?r.x-t.x:t.x+t.w+_>h.x?h.x-t.w-t.x:_,t.w>=e.point2.x-e.point1.x&&t.h>=e.point2.y-e.point1.y&&.8<=t.w/(h.x-r.x)&&.8<=t.h/(h.y-r.y)&&(t.autoCropWarning=!1)}t.x+w<0?t.x=0:t.x+w+t.w>this.w?t.x=this.w-t.w:t.x+=w,t.y+v<0?t.y=0:t.y+v+t.h>this.h?t.y=this.h-t.h:t.y+=v}}})}(IMSoftcrop),function(h){h.Softcrop=function(t,i,e,a,s,o,n,r){h.Shape.call(this,t,i),this.x=s.x,this.y=s.y,this.w=s.w,this.h=s.h,this.usable=!!r,this.locked=!!n,this.respectRatio=o,this.ratio={w:e,h:a,f:h.Ratio.decimal(e,a)},this.handles={nw:[0,0,0],n:[0,0,0],ne:[0,0,0],e:[0,0,0],se:[0,0,0],s:[0,0,0],sw:[0,0,0],w:[0,0,0]},this.ready=!0},h.Softcrop.prototype=Object.create(h.Shape.prototype,{lineWidth:{value:1},lineColor:{value:"rgba(255, 255, 255, 1)"},lineColorActive:{value:"rgba(0, 255, 255, 1)"},handleThickness:{value:3},handleLength:{value:14},handles:{writable:!0},handle:{writable:!0},ratio:{writable:!0},respectRatio:{value:!0,writable:!0},autoCropWarning:{value:!1,writable:!0},locked:{value:!1,writable:!0},usable:{writable:!0},dragHandle:{value:function(t,i){if("string"==typeof this.handle){var e=this.parent.getDimensions(),a=this.x,s=this.y,o=this.w,n=this.h;switch(t){case"n":s+=i.y,n-=i.y,o=h.Ratio.width(n,this.ratio.f),a+=h.Ratio.width(i.y/2,this.ratio.f);break;case"e":o+=i.x,n=h.Ratio.height(o,this.ratio.f),s-=h.Ratio.height(i.x/2,this.ratio.f);break;case"s":n+=i.y,o=h.Ratio.width(n,this.ratio.f),a-=h.Ratio.width(i.y/2,this.ratio.f);break;case"w":o-=i.x,a+=i.x,n=h.Ratio.height(o,this.ratio.f),s+=h.Ratio.height(i.x/2,this.ratio.f);break;case"nw":Math.abs(i.x)>Math.abs(i.y)?(o-=i.x,a+=i.x,n-=h.Ratio.height(i.x,this.ratio.f),s+=h.Ratio.height(i.x,this.ratio.f)):(n-=i.y,s+=i.y,o-=h.Ratio.width(i.y,this.ratio.f),a+=h.Ratio.width(i.y,this.ratio.f));break;case"ne":Math.abs(i.x)>Math.abs(i.y)?(o+=i.x,n+=h.Ratio.height(i.x,this.ratio.f),s-=h.Ratio.height(i.x,this.ratio.f)):(o-=h.Ratio.width(i.y,this.ratio.f),n-=i.y,s+=i.y);break;case"se":Math.abs(i.x)>Math.abs(i.y)?(o+=i.x,n+=h.Ratio.height(i.x,this.ratio.f)):(n+=i.y,o+=h.Ratio.width(i.y,this.ratio.f));break;case"sw":Math.abs(i.x)>Math.abs(i.y)?(o-=i.x,a+=i.x,n-=h.Ratio.height(i.x,this.ratio.f)):(o+=h.Ratio.width(i.y,this.ratio.f),a-=h.Ratio.width(i.y,this.ratio.f),n+=i.y)}n<40||o<40||o>e.w||n>e.h||a+o>e.w||s+n>e.h||(a<0&&(a=0),s<0&&(s=0),this.x=Math.round(a),this.y=Math.round(s),this.w=Math.round(o),this.h=Math.round(n))}}},move:{value:function(t){var i=this.parent.getDimensions();this.x+t.x<0&&(this.x=0,t.x=0),this.y+t.y<0&&(t.y=0,this.y=0),this.w+this.x+Math.round(t.x)>i.w?t.x=i.w-this.w:this.h+this.y+Math.round(t.y)>i.h?t.y=i.h-this.h:h.Shape.prototype.move.call(this,t)}},overHandle:{value:function(t){var i="",e=this.overVerticalArea(t),a=this.overHorizontalArea(t);return i=!a&&!e||a&&e?a==e?"":(i=a+e).replace("m",""):"",this.handle=""!==i&&i,this.handle}},overHorizontalArea:{value:function(t){var i=this.drawX-this.handleThickness,e=this.drawX+this.drawW+this.handleThickness;return this.withinCoordinates(t,i,this.drawY+this.drawH-this.handleLength+this.handleThickness,e,this.drawY+this.drawH+this.handleThickness)?"s":this.withinCoordinates(t,i,this.drawY+this.drawH/2-this.handleLength,e,this.drawY+this.drawH/2+this.handleLength)?"m":this.withinCoordinates(t,i,this.drawY-this.handleThickness,e,this.drawY+this.handleLength)?"n":""}},overVerticalArea:{value:function(t){var i=this.drawY-this.handleThickness,e=this.drawY+this.drawH+this.handleThickness;return this.withinCoordinates(t,this.drawX+this.drawW-this.handleLength,i,this.drawX+this.drawW+this.handleThickness,e)?"e":this.withinCoordinates(t,this.drawX+this.drawW/2-this.handleLength,i,this.drawX+this.drawW/2+this.handleLength,e)?"m":this.withinCoordinates(t,this.drawX-this.handleThickness,i,this.drawX+this.handleLength,e)?"w":""}},redraw:{value:function(t){if(this.ready){this.getDimensionsInCanvas(this.parent.getCoordinates()),this.drawCropMargins();var i=2*this.handleLength;this.ctx.beginPath(),this.drawHandle("nw",!1,this.drawX,this.drawY,this.handleLength,this.handleThickness),this.drawHandle("se",!1,this.drawXW,this.drawYH,this.handleLength,this.handleThickness),this.drawHandle("ne",!1,this.drawXW,this.drawY,this.handleLength,this.handleThickness),this.drawHandle("sw",!1,this.drawX,this.drawYH,this.handleLength,this.handleThickness);var e=this.drawW/2,a=this.drawH/2;this.drawHandle("n",!1,this.drawX+e,this.drawY,i,this.handleThickness),this.drawHandle("e",!1,this.drawXW,this.drawY+a,i,this.handleThickness),this.drawHandle("s",!1,this.drawX+e,this.drawYH,i,this.handleThickness),this.drawHandle("w",!1,this.drawX,this.drawY+a,i,this.handleThickness),this.ctx.stroke(),this.ctx.closePath(),this.drawCropBorder(),"object"==typeof t&&!0===t.guides&&(this.drawCropGuidelines(0,"rgba(55, 55, 55, 0.25)"),this.drawCropGuidelines(-.5,"rgba(255, 255, 255, 0.5)"))}}},drawCropGuidelines:{value:function(t,i){this.ctx.closePath(),this.ctx.beginPath(),this.ctx.setLineDash&&this.ctx.setLineDash([3,3]),this.ctx.strokeStyle=i,this.ctx.lineWidth=1;var e=this.drawH/3,a=this.drawW/3;this.ctx.moveTo(this.drawX,t+this.drawY+e),this.ctx.lineTo(this.drawX+this.drawW,t+this.drawY+e),this.ctx.moveTo(this.drawX,t+this.drawY+e+e),this.ctx.lineTo(this.drawX+this.drawW,t+this.drawY+e+e),this.ctx.moveTo(t+this.drawX+a,this.drawY),this.ctx.lineTo(t+this.drawX+a,this.drawY+this.drawH),this.ctx.moveTo(t+this.drawX+a+a,this.drawY),this.ctx.lineTo(t+this.drawX+a+a,this.drawY+this.drawH),this.ctx.stroke(),this.ctx.setLineDash&&this.ctx.setLineDash([]),this.ctx.closePath()}},drawCropBorder:{value:function(){this.ctx.beginPath(),this.ctx.strokeStyle="rgba(0, 0, 0, 0.3)",this.ctx.lineWidth=1,this.ctx.rect(this.drawX-.5,this.drawY-.5,this.drawW+1,this.drawH+1),this.ctx.stroke(),this.ctx.closePath()}},drawCropMargins:{value:function(){this.ctx.beginPath(),this.ctx.fillStyle="rgba(0, 0, 0, 0.3)",this.ctx.rect(0,0,this.canvas.width,this.drawY),this.ctx.rect(0,0,this.drawX,this.canvas.height),this.ctx.rect(this.drawX,this.drawYH,this.canvas.width,this.canvas.height),this.ctx.rect(this.drawXW,this.drawY,this.canvas.width,this.drawH),this.ctx.fill(),this.ctx.closePath()}},drawHandle:{value:function(t,i,e,a,s,o){var n=o/2,r=s/2;switch(this.ctx.lineWidth=o,this.ctx.strokeStyle=i?this.lineColorActive:this.lineColor,t){case"se":n*=-1,s*=-1;case"nw":this.ctx.moveTo(e-n,a+s),this.ctx.lineTo(e-n,a-n),this.ctx.lineTo(e+s,a-n),this.handles[t]=[e,a,o,s];break;case"sw":n*=-1,s*=-1;case"ne":this.ctx.moveTo(e-s,a-n),this.ctx.lineTo(e+n,a-n),this.ctx.lineTo(e+n,a+s),this.handles[t]=[e,a,o,s];break;case"n":this.ctx.moveTo(e-r,a-n),this.ctx.lineTo(e+r,a-n);break;case"s":this.ctx.moveTo(e-r,a+n),this.ctx.lineTo(e+r,a+n);break;case"w":this.ctx.moveTo(e-n,a+r),this.ctx.lineTo(e-n,a-r);break;case"e":this.ctx.moveTo(e+n,a+r),this.ctx.lineTo(e+n,a-r)}}}}),h.Softcrop.prototype.constructor=h.Softcrop}(IMSoftcrop);