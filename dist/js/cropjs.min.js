/**
 * cropjs - Infomaker image auto cropper. (c) Infomaker
 * @author Danne Lundqvist
 * @version v0.0.1
 * @link http://www.infomaker.se
 * @license Unlicense
 */
!function(){this.IMCropUI=function(){},IMCropUI.Toggle=function(t,i){var e,a=t,n=!1,o=i,s=this;if(e=document.getElementById(a),!e)return void console.log("Element not found: "+a);e.classList.contains("on")&&(n=!0);var r=e.getElementsByTagName("em");1==r.length&&r[0].classList.contains("hint")&&(e.title=r[0].innerHTML),Object.defineProperty(this,"on",{get:function(){return n},set:function(t){n=t,t&&!e.classList.contains("on")?e.classList.add("on"):!t&&e.classList.contains("on")&&e.classList.remove("on")}}),e.addEventListener("click",function(t){return this.classList.toggle("on"),t.preventDefault(),t.stopPropagation(),n=this.classList.contains("on"),"function"==typeof o&&o.call(s,t),!1})},IMCropUI.Button=function(t,i){var e,a=t,n=i,o=this;return(e=document.getElementById(a))?void e.addEventListener("click",function(t){return t.preventDefault(),t.stopPropagation(),"function"==typeof n&&n.call(o,t),!1}):void console.log("Element not found: "+a)}}();var IMSoftcrop=function(){return this.Editor=function(t,i){if(this._id=t,this._crops=[],this.setupUI(),this.adjustForPixelRatio(),this.calculateViewport(),this.addCanvasEventListeners(),this.setupAnimation(),this.runAnimation(),"object"==typeof i){var e=this;i.debug===!0&&("undefined"!=typeof i.debug&&(this._debugContainer=i.debugElement),this._debug=!0),i.autocrop===!0&&(this._autocrop=!0),"string"==typeof i.detectWorkerUrl&&(this._detectWorkerUrl=i.detectWorkerUrl),"number"==typeof i.detectThreshold&&(this._detectThreshold=i.detectThreshold),"number"==typeof i.detectStepSize&&(this._detectStepSize=i.detectStepSize)}this._cropLockedToggle=new IMCropUI.Toggle("imc_croplocked",function(){e._crop instanceof IMSoftcrop.Softcrop&&(e._crop.locked=this.on,e._renderUpdatedPreview(e._crop))}),this._guidesToggle=new IMCropUI.Toggle("imc_guides",function(){e.redraw()}),this._focusPointsToggle=new IMCropUI.Toggle("imc_focuspoints",function(){e.redraw()}),this._saveButton=new IMCropUI.Button("imc_save",function(){e.onButtonSave()}),this._cancelButton=new IMCropUI.Button("imc_cancel",function(){e.onButtonCancel()})},this.Editor.prototype={_id:"",_container:void 0,_canvas:void 0,_ctx:void 0,_redrawCanvas:!1,_previewContainer:void 0,_debugContainer:void 0,_image:void 0,_crops:void 0,_crop:void 0,handle:void 0,info:"image",_dragObject:void 0,_dragPoint:void 0,_position:{x:0,y:0},_zoomLevel:1,_keepCenter:!1,_scale:1,_margin:5,_waitForWorkers:0,_zoomMax:5,_zoomMin:.1,_autocrop:!1,_applyAutocrop:!0,_detectWorkerUrl:void 0,_detectThreshold:60,_detectStepSize:1.6,_debug:!1,_onSave:void 0,_onCancel:void 0,_guidesToggle:void 0,_focusPointsToggle:void 0,_cropLockedToggle:void 0,_saveButton:void 0,_cancelButton:void 0,setupUI:function(){if(this.injectHTML(),this._container=document.getElementById("imc_container"),!this._container)throw new Error("Container element with id <imc_container> not found");if(this._previewContainer=document.getElementById("imc_preview_container"),!this._previewContainer)throw new Error("Preview element with id <imc_preview_container> not found");if(this._canvas=document.getElementById("imc_canvas"),!this._canvas)throw new Error("Canvas element with id <imc_canvas_initial> not found");this._ctx=this._canvas.getContext("2d")},injectHTML:function(){var t=document.getElementById(this._id);if(!t)throw new Error("Could not find element with id <"+this._id+"> to inject crop editor into");t.innerHTML='<div id="imc"><div id="imc_container"><canvas id="imc_canvas"></canvas><div id="imc_work_container"><div id="imc_preview_container" class="imc_preview_container"></div></div><div id="imc_image_inline"><a href="#" id="imc_croplocked" class="toggle"><em class="hint">Låst till användare</em><span><span class="on"><i class="fa fa-lock"></i></span><span class="off"><i class="fa fa-unlock"></i></span></span></a><div id="imc_image_info" class="display"></div><div id="imc_loading"><i class="fa fa-cog fa-spin"></i></div></div><div class="toolbar"><div class="group"><a href="#" id="imc_focuspoints" class="toggle"><em class="hint">Detaljer</em><span><span class="on"><i class="fa fa-object-group"></i></span><span class="off"><i class="fa fa-object-group"></i></span></span></a><a href="#" id="imc_guides" class="toggle on"><em class="hint">Guide lines</em><span><span class="on"><i class="fa fa-th"></i></span><span class="off"><i class="fa fa-th"></i></span></span></a></div><div class="group right"><a href="#" id="imc_cancel" class="button left secondary" style="display: none;">Avbryt</a><a href="#" id="imc_save" class="button right" style="display: none;">Spara</a></div></div></div></div>'},setupAnimation:function(){for(var t=0,i=["webkit","moz"],e=0;e<i.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[i[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[i[e]+"CancelAnimationFrame"]||window[i[e]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(i,e){var a=(new Date).getTime(),n=Math.max(0,16-(a-t)),o=window.setTimeout(function(){i(a+n)},n);return t=a+n,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})},runAnimation:function(){var t=this;if(requestAnimationFrame(function(){t.runAnimation()}),this._redrawCanvas){if(this._redrawCanvas=!1,this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._image instanceof IMSoftcrop.Image){this._image.redraw({guides:this._guidesToggle.on,focuspoints:this._focusPointsToggle.on});for(var i=this._image.getSoftCrops(),e=0;e<i.length;e++)i[e]instanceof IMSoftcrop.Softcrop&&this._renderUpdatedPreview(i[e])}this._debug&&this._renderDebug()}},redraw:function(){this._redrawCanvas=!0},toggleLoadingImage:function(t){var i=document.getElementById("imc_loading");return"undefined"==typeof t?i.classList.contains("loading"):(t?i.classList.add("loading"):i.classList.remove("loading"),t)},_renderNewCropPreview:function(t,i){var e=80,a=this,n=document.createElement("div");n.id=this._image.id+"_"+t.id,n.classList.add("imc_preview_image_container"),i&&n.classList.add("active"),n.addEventListener("click",function(){a.setActiveCrop(t)});var o=document.createElement("div");o.classList.add("imc_preview_image"),o.style.width=IMSoftcrop.Ratio.width(e,t.ratio.f)+"px";var s=document.createElement("span"),r=document.createTextNode(t.id),h=document.createElement("i");h.className="fa fa-warning";var c=document.createElement("b");c.className="fa fa-lock",s.appendChild(r),s.appendChild(h),s.appendChild(c);var d=document.createElement("img");d.src=this._image.src,o.appendChild(d),o.appendChild(s),n.appendChild(o),this._previewContainer.appendChild(n),this._renderUpdatedPreview(t)},_renderUpdatedPreview:function(t){var i=document.getElementById(this._image.id+"_"+t.id);if(null!=i&&"object"==typeof i){var e=this._image.getDimensions(),a=80,n=IMSoftcrop.Ratio.width(a,t.ratio.f),o=t.getDimensions(),s=n/o.w,r=i.getElementsByTagName("IMG");r[0].style.height=e.h*s+"px",r[0].style.marginTop="-"+o.y*s+"px",r[0].style.marginLeft="-"+o.x*s+"px",1==t.autoCropWarning?i.classList.add("warning"):i.classList.remove("warning"),1==t.locked?i.classList.add("locked"):i.classList.remove("locked")}},getDimensions:function(){return{margin:this._margin,width:this._canvas.width,height:this._canvas.height}},updateImageInfo:function(t){var i,e,a,n=t?"crop":"image",o=document.getElementById("imc_image_info");if(o){if(t){if(this._crop instanceof IMSoftcrop.Softcrop==0)return;i=this._crop.getDimensions()}else{if(this._image instanceof IMSoftcrop.Image==0)return;i=this._image.getDimensions()}if(e=Math.round(i.w),a=Math.round(i.h),this.info==n)return void(o.innerHTML=e+"x"+a);this.info=n,o.className="",setTimeout(function(){o.innerHTML=e+"x"+a,o.className="display "+n},200)}},adjustForPixelRatio:function(t){var i=t||this._canvas,e=i.getContext("2d"),a=window.devicePixelRatio||1,n=e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1,o=a/n;if(a!==n){var s=this._container.clientWidth,r=this._container.clientHeight;i.width=s*o,i.height=r*o,i.style.width=s+"px",i.style.height=r+"px",e.scale(o,o),this._scale=o}else i.width=this._container.clientWidth,i.height=this._container.clientHeight},addImage:function(t,i,e){var a=this;this.toggleLoadingImage(!0),this.clear(),this._applyAutocrop=e!==!1,this._image=new IMSoftcrop.Image(IMSoftcrop.Ratio.hashFnv32a(t),this),this._image.load(t,function(){a.setZoomToImage(!1),a.centerImage(!1),a.updateImageInfo(!1),a._autocrop?(a.detectDetails(),a.detectFaces()):a.toggleLoadingImage(!1),a.applySoftcrops(),a.redraw(),"function"==typeof i&&i.call(a,a._image)})},addSoftcrop:function(t,i,e,a,n,o){this._crops.push({id:t,setAsCurrent:0==this._crops.length||i,hRatio:e,vRatio:a,x:"undefined"==typeof n?null:n,y:"undefined"==typeof o?null:o,exact:"undefined"!=typeof n}),this._image instanceof IMSoftcrop.Image&&this._image.ready&&this.applySoftcrops()},getSoftcropData:function(){for(var t={src:this._image.src,width:this._image.w,height:this._image.h,crops:[]},i=0;i<this._image.crops.length;i++)t.crops.push({id:this._image.crops[i].id,x:Math.round(this._image.crops[i].x),y:Math.round(this._image.crops[i].y),width:Math.round(this._image.crops[i].w),height:Math.round(this._image.crops[i].h)});return t},applySoftcrops:function(){if(this._image instanceof IMSoftcrop.Image!=0&&this._image.ready)for(var t=0;t<this._crops.length;t++){var i=this._image.getSoftcrop(this._crops[t].id);if(null==i){var i=this._image.addSoftcrop(this._crops[t].id,this._crops[t].setAsCurrent,this._crops[t].hRatio,this._crops[t].vRatio,this._crops[t].x,this._crops[t].y,this._crops[t].exact);this._autocrop&&this._image.autocrop(),this._renderNewCropPreview(i,this._crops[t].setAsCurrent)}this._crops[t].setAsCurrent&&this.setActiveCrop(i)}},setActiveCrop:function(t){if(t instanceof IMSoftcrop.Softcrop==!0){for(var i=document.getElementById(this._image.id+"_"+t.id),e=this._previewContainer.getElementsByClassName("imc_preview_image_container"),a=0;a<e.length;a++)e[a].classList.remove("active");i.classList.add("active"),this._crop=t,this._image.setActiveCrop(t),this._cropLockedToggle.on=t.locked,this.redraw(),this.updateImageInfo(!0)}},clear:function(){this._image instanceof IMSoftcrop.Image!=0&&(this._image.clear(),this._crops=[],this._crop=void 0,this._image=void 0,this._previewContainer.innerHTML="",this.redraw())},autocropImages:function(){this._autocrop&&this._applyAutocrop&&(this.toggleLoadingImage()||this.toggleLoadingImage(!0),this._image.autocrop()&&this.redraw()),0==this._waitForWorkers&&this.toggleLoadingImage(!1)},getImageData:function(){if(!(!this._image instanceof IMSoftcrop.Image)&&this._image.ready){var t=document.getElementsByTagName("body"),i=document.createElement("canvas"),e=i.getContext("2d");i.style.display="none",t[0].appendChild(i),i.width=this._image.w,i.height=this._image.h,i.style.width=this._image.w+"px",i.style.height=this._image.h+"px",e.drawImage(this._image.image,0,0,this._image.w,this._image.h);var a=e.getImageData(0,0,this._image.w,this._image.h);return e=null,t[0].removeChild(i),i=null,t[0]=null,t=null,a}},detectDetails:function(){if(!(!this._image instanceof IMSoftcrop.Image)&&this._image.ready){var t=this,i=this.getImageData();if(this._waitForWorkers++,window.Worker){var e=new Worker(this._detectWorkerUrl);e.postMessage(["details",i,this._image.w,this._image.h,this._detectThreshold]),e.onmessage=function(i){t.addDetectedDetails(i.data),t._waitForWorkers--,t.autocropImages()}}else{var a=tracking.Fast.findCorners(tracking.Image.grayscale(i.data,this._image.w,this._image.h),this._image.w,this._image.h,this._detectThreshold);this.addDetectedDetails(a),this._waitForWorkers--,this.autocropImages()}}},addDetectedDetails:function(t){for(var i=[],e=0;e<t.length;e+=2)i.push({x:t[e],y:t[e+1]});this._image.addDetailData(i)},detectFaces:function(){if(!(!this._image instanceof IMSoftcrop.Image)&&this._image.ready){this._waitForWorkers++;var t=this;if(window.Worker){var i=new Worker(this._detectWorkerUrl);i.postMessage(["features",this.getImageData(),this._image.w,this._image.h,this._detectStepSize]),i.onmessage=function(i){for(var e=0;e<i.data.length;e++)t.addDetectedFeature(i.data[e]);t._waitForWorkers--,t.autocropImages()}}else{tracking.trackData=function(t,i,e,a){var n=new tracking.TrackerTask(t);return n.on("run",function(){t.track(i.data,e,a)}),n.run()};var e=new tracking.ObjectTracker(["face"]);e.setStepSize(this._detectStepSize),e.on("track",function(i){i.data.forEach(function(i){t.addDetectedFeature(i)}),t._waitForWorkers--,t.autocropImages()}),tracking.trackData(e,this.getImageData(),this._image.w,this._image.h)}}},addDetectedFeature:function(t){var i=0,e={x:t.x,y:t.y};t.width/this._image.w>.45?(t.height*=1.2,e.x+=t.width/2,e.y+=t.height/2,i=t.height>t.width?t.height/2:t.width/2):(t.height*=1.4,e.x+=t.width/2,e.y+=t.height/4,i=t.height>t.width?t.height/2:t.width/2),this._image.addFocusPoint(e,i)},canvasLineInImage:function(t){return t/this._zoomLevel},imageLineInCanvas:function(t){return t*this._zoomLevel},imagePointInCanvas:function(t,i){return{x:Math.round((t+this._image.x)*this._zoomLevel)+this._margin,y:Math.round((i+this._image.y)*this._zoomLevel)+this._margin}},canvasPointInImage:function(t,i){return{x:Math.round((t-this._margin)/this._zoomLevel)-this._image.x,y:Math.round((i-this._margin)/this._zoomLevel)-this._image.y}},centerImage:function(t){var i,e;this._keepCenter=!0,i=this._container.clientWidth/2,e=this._container.clientHeight/2;var a=this._image.w*this._zoomLevel/2+this._image.x*this._zoomLevel+this._margin,n=this._image.h*this._zoomLevel/2+this._image.y*this._zoomLevel+this._margin,o=i==a?0:(i-a)/this._zoomLevel,s=e==n?0:(e-n)/this._zoomLevel;this._image.move({x:o,y:s}),t===!0&&this.redraw()},getZoom:function(t){return t===!0?this._zoomLevel:100*this._zoomLevel},setZoom:function(t,i){this._zoomLevel=t/100,this._keepCenter&&this.centerImage(!1),i===!0&&this.redraw()},setZoomToImage:function(t){var i=this._image.getDimensions(),e=(this._container.clientHeight-2*this._margin)/i.h,a=(this._container.clientWidth-2*this._margin)/i.w;if(a>e&&1>e&&this._zoomLevel>e)this._zoomLevel=e,this.centerImage(!1);else{if(!(1>a&&this._zoomLevel>a))return;this._zoomLevel=a,this.centerImage(!1)}t===!0&&this.redraw()},addCanvasEventListeners:function(){var t=this;window.addEventListener("resize",function(){t.onResize(event)},!1),this._canvas.addEventListener("dblclick",function(i){return t.onDoubleClick(i)}),this._canvas.addEventListener("mousedown",function(i){t.onMouseDown(i)}),this._canvas.addEventListener("mouseup",function(i){t.onMouseUp(i)}),window.addEventListener("mouseup",function(i){t.onMouseUp(i)}),this._canvas.addEventListener("mousemove",function(i){t.onMouseMove(i)}),this._canvas.addEventListener("mousewheel",function(i){return i.stopPropagation(),i.preventDefault(),t.onMouseWheel(i),!1},!1),document.addEventListener("keydown",function(i){var e=i.keyCode||i.which;if(27==e)return t.onCancel(),i.preventDefault(),i.stopPropagation(),!1;if(9==e){for(var a,n=t._image.getSoftCrops(),o=0;o<n.length;o++)if(t._crop===n[o]){a=o;break}return"undefined"!=typeof a&&(o+=i.shiftKey?-1:1,0>o?o=n.length-1:o+1>n.length&&(o=0),t.setActiveCrop(n[o])),i.preventDefault(),i.stopPropagation(),!1}},!1)},onSave:function(t){"function"==typeof t&&(this._onSave=t,document.getElementById("imc_save").style.display="inline")},onCancel:function(t){"function"==typeof t&&(this._onCancel=t,document.getElementById("imc_cancel").style.display="inline")},onButtonSave:function(){return"function"!=typeof this._onSave?void console.log("User save function not defined"):void this._onSave(this.getSoftcropData())},onButtonCancel:function(){return"function"!=typeof this._onCancel?void console.log("User cancel function not defined"):void this._onCancel()},onResize:function(){this._keepCenter&&this.centerImage(!1),this.redraw(),this.calculateViewport()},onDoubleClick:function(t){if(t.preventDefault(),t.stopPropagation(),"undefined"==typeof this._image)return!1;this.toggleLoadingImage(!0),this._focusPointsToggle.on||(this._focusPointsToggle.on=!0);var i=this.getMousePoint(t);return this._image.addFocusPoint(this.canvasPointInImage(i.x,i.y),40),this._image.autocrop()&&(this.redraw(),this.toggleLoadingImage(!1)),!1},onMouseDown:function(t){var i=this.getMousePoint(t);this._crop instanceof IMSoftcrop.Softcrop&&"string"==typeof this.handle?(this.updateImageInfo(!0),this._dragPoint=i,this._dragObject=this.handle):this._crop instanceof IMSoftcrop.Softcrop&&this._crop.inArea(i)?(this.updateImageInfo(!0),this._dragObject=this._crop,this._dragPoint=i):this._image instanceof IMSoftcrop.Image&&this._image.inArea(i)&&(this.updateImageInfo(!1),this._dragObject=this._image,this._dragPoint=i)},onMouseUp:function(){this._dragObject=void 0,this._dragPoint=void 0},onMouseMove:function(t){var i=this.getMousePoint(t);if("undefined"!=typeof this._dragObject)return"string"==typeof this._dragObject?(this._crop.dragHandle(this._dragObject,{x:(i.x-this._dragPoint.x)/this._zoomLevel,y:(i.y-this._dragPoint.y)/this._zoomLevel}),this.updateImageInfo(!0)):(this._dragObject instanceof IMSoftcrop.Image&&(this._keepCenter=!1),this._dragObject.move({x:(i.x-this._dragPoint.x)/this._zoomLevel,y:(i.y-this._dragPoint.y)/this._zoomLevel})),this.updateImageInfo(!0),this.redraw(),void(this._dragPoint=i);if(this._crop instanceof IMSoftcrop.Softcrop){var e=this._crop.overHandle(i);if(e!==!1&&this.handle!=e)return this._canvas.style.cursor="nw"==e||"se"==e?"nwse-resize":"ne"==e||"sw"==e?"nesw-resize":"n"==e||"s"==e?"ns-resize":"ew-resize",void(this.handle=e);if(e===!1&&this.handle)return this._canvas.style.cursor="default",void(this.handle=void 0);if(this.handle)return}return this._image instanceof IMSoftcrop.Image&&this._image.inArea(i)?void(this._canvas.style.cursor="move"):void(this._canvas.style.cursor="default")},onMouseWheel:function(t){var i=Math.max(-1,Math.min(1,t.wheelDelta||-t.detail)),e=0;if(0>i&&this._zoomLevel<this._zoomMax)e=this._zoomLevel<1?.01:.03;else{if(!(i>0&&this._zoomLevel>this._zoomMin))return;e=this._zoomLevel<1?-.01:-.03}var a=(this._image.w/2+this._image.x)*e,n=(this._image.h/2+this._image.y)*e;this._zoomLevel+=e,this._image.move({x:-a/this._zoomLevel,y:-n/this._zoomLevel}),this.redraw()},getMousePoint:function(t){return{x:t.pageX-this._position.x,y:t.pageY-this._position.y}},getCanvas:function(){return this._canvas},calculateViewport:function(){var t=IMSoftcrop.Ratio.getElementPosition(this._canvas);this._position.x=t.x,this._position.y=t.y},_renderDebug:function(){if(this._drawCross("red",{x:this._container.clientWidth/2,y:this._container.clientHeight/2}),this._drawCross("green",{x:this._image.w*this._zoomLevel/2+this._image.x*this._zoomLevel+this._margin,y:this._image.h*this._zoomLevel/2+this._image.y*this._zoomLevel+this._margin}),"undefined"!=typeof this._debugContainer){var t="<pre>";t+="Zoom level: "+this._zoomLevel+"\n","undefined"!=typeof this._image&&(t+="Image w: "+this._image.w+"\n",t+="      h: "+this._image.h+"\n",t+="\n","undefined"!=typeof this._image.crop&&(t+="Crop  x: "+this._image.crop.x+"\n",t+="      y: "+this._image.crop.y+"\n",t+="      w: "+this._image.crop.w+"\n",t+="      h: "+this._image.crop.h+"\n")),t+="</pre>",this._debugContainer.innerHTML=t}},_drawCross:function(t,i){var e=this._canvas.getContext("2d");e.beginPath(),e.fillStyle=t,e.strokeStyle=t,e.lineWidth=.5,e.arc(i.x,i.y,5,0,2*Math.PI,!1),e.fill(),e.beginPath(),e.moveTo(i.x-50,i.y),e.lineTo(i.x+50,i.y),e.stroke(),e.beginPath(),e.moveTo(i.x,i.y-50),e.lineTo(i.x,i.y+50),e.stroke()}},this}();!function(t){t.Ratio=function(){},t.Ratio.decimal=function(t,i){return i/t},t.Ratio.height=function(t,i){return Math.round(t*i)},t.Ratio.width=function(t,i){return Math.round(t/i)},t.Ratio.fitInto=function(i,e){var a=t.Ratio.decimal(e.w,e.h),n=t.Ratio.decimal(i.w,i.h),o=0,s=0,r=i.w,h=i.h;return n>a?(h=t.Ratio.height(r,a),s=(i.h-h)/2):(r=t.Ratio.width(h,a),o=(i.w-r)/2),{x:o,y:s,w:r,h:h}},t.Ratio.fitAround=function(i,e){var a=t.Ratio.decimal(i.w,i.h),n=0,o=0;return 1==a?o=n=e.w>e.h?e.w:e.h:i.w/e.w>i.h/e.h?(o=e.h,n=e.h*(i.w/i.h)):(n=e.w,o=e.w*(i.h/i.w)),{w:n,h:o}},t.Ratio.getElementPosition=function(t){for(var i=0,e=0;t;)i+=t.offsetLeft-t.scrollLeft+t.clientLeft,e+=t.offsetTop-t.scrollTop+t.clientTop,t=t.offsetParent;return{x:i,y:e}},t.Ratio.hashFnv32a=function(t,i){var e,a,n=void 0===i?2166136261:i;for(e=0,a=t.length;a>e;e++)n^=t.charCodeAt(e),n+=(n<<1)+(n<<4)+(n<<7)+(n<<8)+(n<<24);return("0000000"+(n>>>0).toString(16)).substr(-8)},t.Ratio.areaCoverage=function(t,i,e,a){return Math.round(100*t*i/(e*a))}}(IMSoftcrop),function(t){t.Base=function(){},t.Base.prototype={},t.Shape=function(i,e){this.id=i,this.parent=e;var a=e;do{if(a instanceof t.Editor){this.editor=a;break}a=a.parent}while("undefined"!=typeof a);var n=this.editor.getCanvas();if(!n||"CANVAS"!=n.tagName)throw new TypeError("Canvas required");this.canvas=n,this.ctx=n.getContext("2d")},t.Shape.prototype=Object.create(t.Base.prototype,{id:{writable:!0},editor:{writable:!0},parent:{writable:!0},canvas:{writable:!0},ctx:{writable:!0},_ready:{value:!1,writable:!0},ready:{get:function(){return this._ready},set:function(t){this._ready=t===!0}},x:{value:0,writable:!0},y:{value:0,writable:!0},w:{value:0,writable:!0},h:{value:0,writable:!0},drawX:{value:0,writable:!0},drawY:{value:0,writable:!0},drawW:{value:0,writable:!0},drawH:{value:0,writable:!0},drawXW:{value:0,writable:!0},drawYH:{value:0,writable:!0},getCanvas:{value:function(){return this.canvas}},inArea:{value:function(t){return this.ready?this.inCalculatedArea(t,this.drawX,this.drawY,this.drawW,this.drawH):!1}},withinCoordinates:{value:function(t,i,e,a,n){return t.x<i||t.x>a?!1:t.y<e||t.y>n?!1:!0}},inCalculatedArea:{value:function(t,i,e,a,n){return t.x>=i&&t.x<=i+a&&t.y>=e&&t.y<=e+n?!0:!1}},move:{value:function(t){this.x+=Math.round(t.x),this.y+=Math.round(t.y)}},getCoordinates:{value:function(){return{x:this.x,y:this.y}}},getDimensions:{value:function(){return{x:this.x,y:this.y,w:this.w,h:this.h}}},getDimensionsInCanvas:{value:function(t){"undefined"==typeof t&&(t={x:0,y:0});var i=this.editor.getDimensions(),e=this.editor.getZoom(!0);this.drawW=Math.round(this.w*e),this.drawH=Math.round(this.h*e),this.drawX=Math.round((this.x+t.x)*e)+i.margin,this.drawY=Math.round((this.y+t.y)*e)+i.margin,this.drawXW=this.drawX+this.drawW,this.drawYH=this.drawY+this.drawH}}}),t.Shape.prototype.constructor=t.Shape}(IMSoftcrop),function(t){t.Image=function(i,e){t.Shape.call(this,i,e),this.crops=[],this.focusPoints=[]},t.Image.prototype=Object.create(Shape.prototype,{src:{value:"string",writable:!0},image:{writable:!0},crops:{writable:!0},focusPoints:{writable:!0},focusArea:{writable:!0},detailData:{writable:!0},detailArea:{writable:!0},load:{value:function(t,i){var e=document.createElement("img"),a=this;e.crossOrigin="*",e.addEventListener("load",function(){a.w=this.naturalWidth,a.h=this.naturalHeight,a.image=this,a.ready=!0,i()},!1),e.src=t,this.src=t}},clear:{value:function(){for(var t=0;t<this.crops.length;t++)this.crops[t]=null;this.crops=[],this.crop=null,this.image=null}},addSoftcrop:{value:function(i,e,a,n,o,s,r){var h;if(null!=(h=this.getSoftcrop(i)))return h;var c;return c=null===o||null===s?t.Ratio.fitInto({w:this.w,h:this.h},{w:a,h:n}):{x:o,y:s,w:a,h:n},h=new t.Softcrop(i,this,a,n,c,!0,r),this.crops.push(h),e&&(this.crop=h),h}},getSoftcrop:{value:function(t){for(var i=0;i<this.crops.length;i++)if(this.crops[i].id==t)return this.crops[i];return null}},detectionReady:{value:function(){return"undefined"!=typeof this.detailArea}},getSoftCrops:{value:function(){return this.crops}},setActiveCrop:{value:function(t){this.crop=t}},getSrc:{value:function(){return this.src}},addDetailData:{value:function(t){this.detailData=t;for(var i={point1:{x:t[0].x,y:t[0].y},point2:{x:t[0].x,y:t[0].y}},e=1;e<t.length;e++)t[e].x<i.point1.x?i.point1.x=t[e].x:t[e].x>i.point2.x&&(i.point2.x=t[e].x),t[e].y<i.point1.y?i.point1.y=t[e].y:t[e].y>i.point2.y&&(i.point2.y=t[e].y);this.detailArea=i,this.constrainArea(this.detailArea)}},addFocusPoint:{value:function(t,i){return t.r=i,this.focusPoints.push(t),"undefined"==typeof this.focusArea?void(this.focusArea={point1:{x:t.x-i,y:t.y-i},point2:{x:t.x+i,y:t.y+i}}):(t.x-t.r<this.focusArea.point1.x&&(this.focusArea.point1.x=t.x-t.r),t.x+t.r>this.focusArea.point2.x&&(this.focusArea.point2.x=t.x+t.r),t.y-t.r<this.focusArea.point1.y&&(this.focusArea.point1.y=t.y-t.r),t.y+t.r>this.focusArea.point2.y&&(this.focusArea.point2.y=t.y+t.r),void this.constrainArea(this.focusArea))}},constrainArea:{value:function(t){t.point1.x<0&&(t.point1.x=0),t.point2.x>this.w&&(t.point2.x=this.w),t.point1.y<0&&(t.point1.y=0),t.point2.y>this.h&&(t.point2.y=this.h)}},redraw:{value:function(i){this.ready&&(this.getDimensionsInCanvas({x:0,y:0}),this.ctx.drawImage(this.image,this.drawX,this.drawY,this.drawW,this.drawH),"object"==typeof i&&i.focuspoints===!0&&this.drawFocusPoints(),this.crop instanceof t.Softcrop&&this.crop.redraw(i))}},drawFocusPoints:{value:function(){if("undefined"!=typeof this.detailArea){this.drawArea(this.detailArea,"rgba(255, 121, 255, 0.4)"),this.ctx.fillStyle="rgba(255, 121, 255, 0.5)";for(var t=0;t<this.detailData.length;t++){var i=this.editor.imagePointInCanvas(this.detailData[t].x,this.detailData[t].y);this.ctx.fillRect(i.x,i.y-3,6,6)}}if("undefined"!=typeof this.focusArea){this.drawArea(this.focusArea,"rgba(121, 121, 255, 0.4)");for(var e=0;e<this.focusPoints.length;e++){var a=this.editor.imagePointInCanvas(this.focusPoints[e].x,this.focusPoints[e].y),n=this.editor.imageLineInCanvas(this.focusPoints[e].r);this.ctx.beginPath(),this.ctx.fillStyle="rgba(255, 255, 255, 0.5)",this.ctx.lineWidth=1,this.ctx.arc(a.x,a.y,n,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.closePath()}}}},drawArea:{value:function(t,i){var e=this.editor.imagePointInCanvas(t.point1.x,t.point1.y),a=this.editor.imagePointInCanvas(t.point2.x,t.point2.y);this.ctx.strokeStyle=i,this.ctx.lineWidth=4,this.ctx.strokeRect(e.x+2,e.y+2,a.x-e.x-4,a.y-e.y-4)}},autocrop:{value:function(t){if(!this.detectionReady())return!1;for(var i="undefined"!=typeof t?new Array(t):this.crops,e=0;e<i.length;e++)i[e].locked||this.autoCropCrop(i[e]);return!0}},autoCropCrop:{value:function(i){var e=this.detailArea,a="undefined"!=typeof this.focusArea?this.focusArea:this.detailArea,n=e.point1.x<a.point1.x?e.point1.x:a.point1.x,o=e.point2.x>a.point2.x?e.point2.x:a.point2.x,s=e.point1.y<a.point1.x?e.point1.y:a.point1.y,r=e.point2.y>a.point2.y?e.point2.y:a.point2.y,h={point1:{x:n>0?n:0,y:s>0?s:0},point2:{x:o<this.w?o:this.w,y:r<this.h?r:this.h}},c=t.Ratio.fitAround({w:i.ratio.w,h:i.ratio.h},{w:h.point2.x-h.point1.x,h:h.point2.y-h.point1.y});c.w<=this.w&&c.h<=this.h?(i.w=c.w,i.h=c.h):c.w>this.w?(i.w=this.w,i.h=t.Ratio.height(this.w,i.ratio.f),i.autoCropWarning=!0):c.h>this.h?(i.h=this.h,i.w=t.Ratio.width(this.h,i.ratio.f),i.autoCropWarning=!0):(console.log("Too wide and too high, how?!? Ignoring!"),i.autoCropWarning=!0);var d={x:h.point1.x+(h.point2.x-h.point1.x)/2,y:h.point1.y+(h.point2.y-h.point1.y)/2},l={x:a.point1.x+(a.point2.x-a.point1.x)/2,y:a.point1.y+(a.point2.y-a.point1.y)/2},u={x:i.x+i.w/2,y:i.y+i.h/2},g=d.x-u.x,p=d.y-u.y;if(i.autoCropWarning){var f=l.y-u.y;p=i.y+f<h.point1.y?h.point1.y-i.y:i.y+i.h+f>h.point2.y?h.point2.y-i.h-i.y:f;var m=l.x-u.x;g=i.x+m<h.point1.x?h.point1.x-i.x:i.x+i.w+m>h.point2.x?h.point2.x-i.w-i.x:m,i.w>=a.point2.x-a.point1.x&&i.h>=a.point2.y-a.point1.y&&.8<=i.w/(h.point2.x-h.point1.x)&&.8<=i.h/(h.point2.y-h.point1.y)&&(i.autoCropWarning=!1)}i.x+g<0?i.x=0:i.x+g+i.w>this.w?i.x=this.w-i.w:i.x+=g,i.y+p<0?i.y=0:i.y+p+i.h>this.h?i.y=this.h-i.h:i.y+=p}}})}(IMSoftcrop),function(t){t.Softcrop=function(i,e,a,n,o,s,r){t.Shape.call(this,i,e),this.x=o.x,this.y=o.y,this.w=o.w,this.h=o.h,this.locked=r,this.respectRatio=s,this.ratio={w:a,h:n,f:t.Ratio.decimal(a,n)},this.handles={nw:[0,0,0],n:[0,0,0],ne:[0,0,0],e:[0,0,0],se:[0,0,0],s:[0,0,0],sw:[0,0,0],w:[0,0,0]},this.ready=!0},t.Softcrop.prototype=Object.create(Shape.prototype,{lineWidth:{value:1},lineColor:{value:"rgba(255, 255, 255, 1)"},lineColorActive:{value:"rgba(0, 255, 255, 1)"},handleThickness:{value:3},handleLength:{value:14},handles:{writable:!0},handle:{writable:!0},ratio:{writable:!0},respectRatio:{value:!0,writable:!0},autoCropWarning:{value:!1,writable:!0},locked:{value:!1,writable:!0},dragHandle:{value:function(i,e){if("string"==typeof this.handle){var a=this.parent.getDimensions(),n=this.x,o=this.y,s=this.w,r=this.h;switch(i){case"n":o+=e.y,r-=e.y,s=t.Ratio.width(r,this.ratio.f),n+=t.Ratio.width(e.y/2,this.ratio.f);break;case"e":s+=e.x,r=t.Ratio.height(s,this.ratio.f),o-=t.Ratio.height(e.x/2,this.ratio.f);break;case"s":r+=e.y,s=t.Ratio.width(r,this.ratio.f),n-=t.Ratio.width(e.y/2,this.ratio.f);break;case"w":s-=e.x,n+=e.x,r=t.Ratio.height(s,this.ratio.f),o+=t.Ratio.height(e.x/2,this.ratio.f);break;case"nw":Math.abs(e.x)>Math.abs(e.y)?(s-=e.x,n+=e.x,r-=t.Ratio.height(e.x,this.ratio.f),o+=t.Ratio.height(e.x,this.ratio.f)):(r-=e.y,o+=e.y,s-=t.Ratio.width(e.y,this.ratio.f),n+=t.Ratio.width(e.y,this.ratio.f));break;case"ne":Math.abs(e.x)>Math.abs(e.y)?(s+=e.x,r+=t.Ratio.height(e.x,this.ratio.f),o-=t.Ratio.height(e.x,this.ratio.f)):(s-=t.Ratio.width(e.y,this.ratio.f),r-=e.y,o+=e.y);break;case"se":Math.abs(e.x)>Math.abs(e.y)?(s+=e.x,r+=t.Ratio.height(e.x,this.ratio.f)):(r+=e.y,s+=t.Ratio.width(e.y,this.ratio.f));break;case"sw":Math.abs(e.x)>Math.abs(e.y)?(s-=e.x,n+=e.x,r-=t.Ratio.height(e.x,this.ratio.f)):(s+=t.Ratio.width(e.y,this.ratio.f),n-=t.Ratio.width(e.y,this.ratio.f),r+=e.y)}40>r||40>s||s>a.w||r>a.h||n+s>a.w||o+r>a.h||(0>n&&(n=0),0>o&&(o=0),this.x=Math.round(n),this.y=Math.round(o),this.w=Math.round(s),this.h=Math.round(r))}}},move:{value:function(i){var e=this.parent.getDimensions();return this.x+i.x<0&&(this.x=0,i.x=0),this.y+i.y<0&&(i.y=0,this.y=0),this.w+this.x+Math.round(i.x)>e.w?void(i.x=e.w-this.w):this.h+this.y+Math.round(i.y)>e.h?void(i.y=e.h-this.h):void t.Shape.prototype.move.call(this,i)}},overHandle:{value:function(t){var i="",e=this.overVerticalArea(t),a=this.overHorizontalArea(t);return!a&&!e||a&&e?a==e?i="":(i=a+e,i=i.replace("m","")):i="",this.handle=""===i?!1:i,this.handle}},overHorizontalArea:{value:function(t){var i=this.drawX-this.handleThickness,e=this.drawX+this.drawW+this.handleThickness;return this.withinCoordinates(t,i,this.drawY+this.drawH-this.handleLength+this.handleThickness,e,this.drawY+this.drawH+this.handleThickness)?"s":this.withinCoordinates(t,i,this.drawY+this.drawH/2-this.handleLength,e,this.drawY+this.drawH/2+this.handleLength)?"m":this.withinCoordinates(t,i,this.drawY-this.handleThickness,e,this.drawY+this.handleLength)?"n":""}},overVerticalArea:{value:function(t){var i=this.drawY-this.handleThickness,e=this.drawY+this.drawH+this.handleThickness;return this.withinCoordinates(t,this.drawX+this.drawW-this.handleLength,i,this.drawX+this.drawW+this.handleThickness,e)?"e":this.withinCoordinates(t,this.drawX+this.drawW/2-this.handleLength,i,this.drawX+this.drawW/2+this.handleLength,e)?"m":this.withinCoordinates(t,this.drawX-this.handleThickness,i,this.drawX+this.handleLength,e)?"w":""}},redraw:{value:function(t){if(this.ready){this.getDimensionsInCanvas(this.parent.getCoordinates()),this.drawCropMargins();var i=2*this.handleLength;this.ctx.beginPath(),this.drawHandle("nw",!1,this.drawX,this.drawY,this.handleLength,this.handleThickness),this.drawHandle("se",!1,this.drawXW,this.drawYH,this.handleLength,this.handleThickness),this.drawHandle("ne",!1,this.drawXW,this.drawY,this.handleLength,this.handleThickness),this.drawHandle("sw",!1,this.drawX,this.drawYH,this.handleLength,this.handleThickness);var e=this.drawW/2,a=this.drawH/2;this.drawHandle("n",!1,this.drawX+e,this.drawY,i,this.handleThickness),this.drawHandle("e",!1,this.drawXW,this.drawY+a,i,this.handleThickness),this.drawHandle("s",!1,this.drawX+e,this.drawYH,i,this.handleThickness),this.drawHandle("w",!1,this.drawX,this.drawY+a,i,this.handleThickness),
this.ctx.stroke(),this.ctx.closePath(),this.drawCropBorder(),"object"==typeof t&&t.guides===!0&&(this.drawCropGuidelines(0,"rgba(55, 55, 55, 0.25)"),this.drawCropGuidelines(-.5,"rgba(255, 255, 255, 0.5)"))}}},drawCropGuidelines:{value:function(t,i){this.ctx.closePath(),this.ctx.beginPath(),this.ctx.setLineDash&&this.ctx.setLineDash([3,3]),this.ctx.strokeStyle=i,this.ctx.lineWidth=1;var e=this.drawH/3,a=this.drawW/3;this.ctx.moveTo(this.drawX,t+this.drawY+e),this.ctx.lineTo(this.drawX+this.drawW,t+this.drawY+e),this.ctx.moveTo(this.drawX,t+this.drawY+e+e),this.ctx.lineTo(this.drawX+this.drawW,t+this.drawY+e+e),this.ctx.moveTo(t+this.drawX+a,this.drawY),this.ctx.lineTo(t+this.drawX+a,this.drawY+this.drawH),this.ctx.moveTo(t+this.drawX+a+a,this.drawY),this.ctx.lineTo(t+this.drawX+a+a,this.drawY+this.drawH),this.ctx.stroke(),this.ctx.setLineDash&&this.ctx.setLineDash([]),this.ctx.closePath()}},drawCropBorder:{value:function(){this.ctx.beginPath(),this.ctx.strokeStyle="rgba(0, 0, 0, 0.3)",this.ctx.lineWidth=1,this.ctx.rect(this.drawX-.5,this.drawY-.5,this.drawW+1,this.drawH+1),this.ctx.stroke(),this.ctx.closePath()}},drawCropMargins:{value:function(){this.ctx.beginPath(),this.ctx.fillStyle="rgba(0, 0, 0, 0.3)",this.ctx.rect(0,0,this.canvas.width,this.drawY),this.ctx.rect(0,0,this.drawX,this.canvas.height),this.ctx.rect(this.drawX,this.drawYH,this.canvas.width,this.canvas.height),this.ctx.rect(this.drawXW,this.drawY,this.canvas.width,this.drawH),this.ctx.fill(),this.ctx.closePath()}},drawHandle:{value:function(t,i,e,a,n,o){var s=o/2,r=n/2;switch(this.ctx.lineWidth=o,this.ctx.strokeStyle=i?this.lineColorActive:this.lineColor,t){case"se":s=-1*s,n=-1*n;case"nw":this.ctx.moveTo(e-s,a+n),this.ctx.lineTo(e-s,a-s),this.ctx.lineTo(e+n,a-s),this.handles[t]=[e,a,o,n];break;case"sw":s=-1*s,n=-1*n;case"ne":this.ctx.moveTo(e-n,a-s),this.ctx.lineTo(e+s,a-s),this.ctx.lineTo(e+s,a+n),this.handles[t]=[e,a,o,n];break;case"n":this.ctx.moveTo(e-r,a-s),this.ctx.lineTo(e+r,a-s);break;case"s":this.ctx.moveTo(e-r,a+s),this.ctx.lineTo(e+r,a+s);break;case"w":this.ctx.moveTo(e-s,a+r),this.ctx.lineTo(e-s,a-r);break;case"e":this.ctx.moveTo(e+s,a+r),this.ctx.lineTo(e+s,a-r)}}}}),t.Softcrop.prototype.constructor=t.Softcrop}(IMSoftcrop);